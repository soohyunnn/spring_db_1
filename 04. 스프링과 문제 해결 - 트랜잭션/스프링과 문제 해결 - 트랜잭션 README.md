# ìŠ¤í”„ë§ê³¼ ë¬¸ì œ í•´ê²° - íŠ¸ëœì­ì…˜

## ë¬¸ì œì ë“¤

### ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì¡°

ì—¬ëŸ¬ê°€ì§€ ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì¡°ê°€ ìˆì§€ë§Œ, ê°€ì¥ ë‹¨ìˆœí•˜ë©´ì„œ ë§ì´ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì€ ì—­í• ì— ë”°ë¼ 3ê°€ì§€ ê³„ì¸µìœ¼ë¡œ ë‚˜ëˆ„ëŠ” ê²ƒì´ë‹¤.

![Untitled](https://github.com/soohyunnn/spring_db_1/assets/58289675/94017d75-f975-4751-a806-983633e837ba)

- **í”„ë ˆì  í…Œì´ì…˜ ê³„ì¸µ**
    - UIì™€ ê´€ë ¨ëœ ì²˜ë¦¬ ë‹´ë‹¹
    - ì›¹ ìš”ì²­ê³¼ ì‘ë‹µ
    - ì‚¬ìš©ì ìš”ì²­ì„ ê²€ì¦
    - ì£¼ ì‚¬ìš© ê¸°ìˆ  : ì„œë¸”ë¦¿ê³¼ HTTP ê°™ì€ ì›¹ ê¸°ìˆ , ìŠ¤í”„ë§ MVC
- **ì„œë¹„ìŠ¤ ê³„ì¸µ**
    - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹´ë‹¹
    - ì£¼ ì‚¬ìš© ê¸°ìˆ  : ê°€ê¸‰ì  íŠ¹ì • ê¸°ìˆ ì— ì˜ì¡´í•˜ì§€ ì•Šê³ , ìˆœìˆ˜ ìë°” ì½”ë“œë¡œ ì‘ì„±
- **ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ**
    - ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ê·¼í•˜ëŠ” ì½”ë“œ
    - ì£¼ ì‚¬ìš© ê¸°ìˆ  : JDBC, JPA, File, Redis, Mongo â€¦

**ìˆœìˆ˜í•œ ì„œë¹„ìŠ¤ ê³„ì¸µ**

- ì—¬ê¸°ì„œ ê°€ì¥ ì¤‘ìš”í•œ ê³³ì€ ì–´ë””ì¼ê¹Œ? ë°”ë¡œ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ë“¤ì–´ìˆëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µì´ë‹¤. ì‹œê°„ì´ í˜ëŸ¬ì„œ UI(ì›¹)ì™€ ê´€ë ¨ëœ ë¶€ë¶„ì´ ë³€í•˜ê³ , ë°ì´í„° ì €ì¥ ê¸°ìˆ ì„ ë‹¤ë¥¸ ê¸°ìˆ ë¡œ ë³€ê²½í•´ë„, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ìµœëŒ€í•œ ë³€ê²½ì—†ì´ ìœ ì§€ë˜ì–´ì•¼ í•œë‹¤.
- ì´ë ‡ê²Œ í•˜ë ¤ë©´ ì„œë¹„ìŠ¤ ê³„ì¸µì„ íŠ¹ì • ê¸°ìˆ ì— ì¢…ì†ì ì´ì§€ ì•Šê²Œ ê°œë°œí•´ì•¼ í•œë‹¤.
    - ì´ë ‡ê²Œ ê³„ì¸µì„ ë‚˜ëˆˆ ì´ìœ ë„ ì„œë¹„ìŠ¤ ê³„ì¸µì„ ìµœëŒ€í•œ ìˆœìˆ˜í•˜ê²Œ ìœ ì§€í•˜ê¸° ìœ„í•œ ëª©ì ì´ í¬ë‹¤. ê¸°ìˆ ì— ì¢…ì†ì ì¸ ë¶€ë¶„ì€ í”„ë ˆì  í…Œì´ì…˜ ê³„ì¸µ, ë°ì´í„° ì ‘ê·¼ ê³„ì¸µì—ì„œ ê°€ì§€ê³  ê°„ë‹¤.
    - í”„ë ˆì  í…Œì´ì…˜ ê³„ì¸µì€ í´ë¼ì´ì–¸íŠ¸ê°€ ì ‘ê·¼í•˜ëŠ” UIì™€ ê´€ë ¨ëœ ê¸°ìˆ ì¸ ì›¹, ì„œë¸”ë¦¿, HTTPì™€ ê´€ë ¨ëœ ë¶€ë¶„ì„ ë‹´ë‹¹í•´ì¤€ë‹¤. ê·¸ë˜ì„œ ì„œë¹„ìŠ¤ ê³„ì¸µì„ ì´ëŸ° UIì™€ ê´€ë ¨ëœ ê¸°ìˆ ë¡œë¶€í„° ë³´í˜¸í•´ì¤€ë‹¤. ì˜ˆë¥¼ ë“¤ì–´ì„œ HTTP APIë¥¼ ì‚¬ìš©í•˜ë‹¤ê°€ GRPC ê°™ì€ ê¸°ìˆ ë¡œ ë³€ê²½í•´ë„ í”„ë ˆì  í…Œì´ì…˜ ê³„ì¸µì˜ ì½”ë“œë§Œ ë³€ê²½í•˜ê³ , ì„œë¹„ìŠ¤ ê³„ì¸µì€ ë³€ê²½í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.
    - ë°ì´í„° ì ‘ê·¼ ê³„ì¸µì€ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  ê´€ë¦¬í•˜ëŠ” ê¸°ìˆ ì„ ë‹´ë‹¹í•´ì¤€ë‹¤. ê·¸ë˜ì„œ JDBC, JPAì™€ ê°™ì€ êµ¬ì²´ì ì¸ ë°ì´í„° ì ‘ê·¼ ê¸°ìˆ ë¡œë¶€í„° ì„œë¹„ìŠ¤ ê³„ì¸µì„ ë³´í˜¸í•´ì¤€ë‹¤. ì˜ˆë¥¼ ë“¤ì–´ì„œ JDBCë¥¼ ì‚¬ìš©í•˜ë‹¤ê°€ JPAë¡œ ë³€ê²½í•´ë„ ì„œë¹„ìŠ¤ ê³„ì¸µì€ ë³€ê²½í•˜ì§€ ì•Šì•„ë„ ëœë‹¤. ë¬¼ë¡  ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ ë°ì´í„° ì ‘ê·¼ ê³„ì¸µì„ ì§ì ‘ ì ‘ê·¼í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•˜ê³  ì„œë¹„ìŠ¤ ê³„ì¸µì€ ì´ ì¸í„°í˜ì´ìŠ¤ì— ì˜ì¡´í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤. ê·¸ë˜ì•¼ ì„œë¹„ìŠ¤ ì½”ë“œì˜ ë³€ê²½ ì—†ì´ `JdbcRepository`ë¥¼ `JpaRepository`ë¡œ ë³€ê²½í•  ìˆ˜ ìˆë‹¤.
- ì„œë¹„ìŠ¤ ê³„ì¸µì´ íŠ¹ì • ê¸°ìˆ ì— ì¢…ì†ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ìœ ì§€ë³´ìˆ˜ í•˜ê¸°ë„ ì‰½ê³ , í…ŒìŠ¤íŠ¸ í•˜ê¸°ë„ ì‰½ë‹¤.
- ì •ë¦¬í•˜ìë©´ ì„œë¹„ìŠ¤ ê³„ì¸µì€ ê°€ê¸‰ì  ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ êµ¬í˜„í•˜ê³  íŠ¹ì • êµ¬í˜„ ê¸°ìˆ ì— ì§ì ‘ ì˜ì¡´í•´ì„œëŠ” ì•ˆëœë‹¤.
    
    ì´ë ‡ê²Œ í•˜ë©´ í–¥í›„ êµ¬í˜„ ê¸°ìˆ ì´ ë³€ê²½ë  ë•Œ ë³€ê²½ì˜ ì˜í–¥ ë²”ìœ„ë¥¼ ìµœì†Œí™” í•  ìˆ˜ ìˆë‹¤.
    

### ë¬¸ì œì ë“¤

ì„œë¹„ìŠ¤ ê³„ì¸µì„ ìˆœìˆ˜í•˜ê²Œ ìœ ì§€í•˜ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œ? ì§€ê¸ˆê¹Œì§€ ê°œë°œí•œ MemberService ì½”ë“œë“¤ì„ ì‚´í´ë³´ì.

**MemberServiceV1**

```java
package hello.jdbc.service;

import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepositoryV1;
import lombok.RequiredArgsConstructor;

import java.sql.SQLException;

@RequiredArgsConstructor
public class MemberServiceV1 {

    private final MemberRepositoryV1 memberRepository;

    public void accountTransfer(String fromId, String toId, int money) throws SQLException {
        Member fromMember = memberRepository.findById(fromId);
        Member toMember = memberRepository.findById(toId);

        memberRepository.update(fromId, fromMember.getMoney() - money);
        memberRepository.update(toId, toMember.getMoney() + money);
    }

}
```

- `MemberServiceV1` ì€ íŠ¹ì • ê¸°ìˆ ì— ì¢…ì†ì ì´ì§€ ì•Šê³ , ìˆœìˆ˜í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ ì¡´ì¬í•œë‹¤.
- íŠ¹ì • ê¸°ìˆ ê³¼ ê´€ë ¨ëœ ì½”ë“œê°€ ê±°ì˜ ì—†ì–´ì„œ ì½”ë“œê°€ ê¹”ë”í•˜ê³ , ìœ ì§€ë³´ìˆ˜ í•˜ê¸° ì‰½ë‹¤.
- í–¥í›„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ ë³€ê²½ì´ í•„ìš”í•˜ë©´ ì´ ë¶€ë¶„ì„ ë³€ê²½í•˜ë©´ ëœë‹¤.

ì‚¬ì‹¤ ì—¬ê¸°ì—ë„ ë‚¨ì€ ë¬¸ì œê°€ ìˆë‹¤. (ì§€ê¸ˆ ë‹¨ê³„ì—ì„œ ì´ ë¬¸ì œë“¤ì€ ì´ëŸ°ê²Œ ìˆêµ¬ë‚˜ ì°¸ê³ ë§Œ í•˜ê³  ë„˜ì–´ê°€ì)

- `SQLException`ì´ë¼ëŠ” JDBC ê¸°ìˆ ì— ì˜ì¡´í•œë‹¤ëŠ” ì ì´ë‹¤.
- ì´ ë¶€ë¶„ì€ `memberRepository`ì—ì„œ ì˜¬ë¼ì˜¤ëŠ” ì˜ˆì™¸ì´ê¸° ë•Œë¬¸ì— `memberRepository`ì—ì„œ í•´ê²°í•´ì•¼ í•œë‹¤.
    
    ì´ ë¶€ë¶„ì€ ë’¤ì—ì„œ ì˜ˆì™¸ë¥¼ ë‹¤ë£° ë•Œ ì•Œì•„ë³´ì.
    
- `MemberRepositoryV1`ì´ë¼ëŠ” êµ¬ì²´ í´ë˜ìŠ¤ì— ì§ì ‘ ì˜ì¡´í•˜ê³  ìˆë‹¤. `MemberRepository` ì¸í„°í˜ì´ìŠ¤ë¥¼ ë„ì…í•˜ë©´ í–¥í›„ `MemberService`ì˜ ì½”ë“œì˜ ë³€ê²½ ì—†ì´ ë‹¤ë¥¸ êµ¬í˜„ ê¸°ìˆ ë¡œ ì†ì‰½ê²Œ ë³€ê²½í•  ìˆ˜ ìˆë‹¤.

**MemberServiceV2**

```java
package hello.jdbc.service;

import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepositoryV2;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

import javax.sql.DataSource;
import java.sql.Connection;
import java.sql.SQLException;

/**
 *
 */
@Slf4j
@RequiredArgsConstructor
public class MemberServiceV2 {

    private final DataSource dataSource;
    private final MemberRepositoryV2 memberRepository;

    public void accountTransfer(String fromId, String toId, int money) throws SQLException {
        Connection con = dataSource.getConnection();
        try {
            con.setAutoCommit(false);  //íŠ¸ëœì­ì…˜ ì‹œì‘
            //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
            bizLogic(con, fromId, toId, money);
            con.commit();  //ì„±ê³µì‹œ ì»¤ë°‹
        } catch (Exception e) {
            con.rollback();  //ì‹¤íŒ¨ì‹œ ë¡ë°±
            throw new IllegalStateException(e);
        } finally {
            release(con);
        }
    }

    private void bizLogic(Connection con, String fromId, String toId, int money) throws  SQLException {
        Member fromMember = memberRepository.findById(con, fromId);
        Member toMember = memberRepository.findById(con, toId);

        memberRepository.update(con, fromId, fromMember.getMoney() - money);
        memberRepository.update(con, toId, toMember.getMoney() + money);

    }

    private void release(Connection con) {
        if (con != null) {
            try {
                con.setAutoCommit(true);  //ì»¤ë„¥ì…˜ í’€ ê³ ë ¤
                con.close();
            } catch (Exception e) {
                log.info("error", e);
            }
        }
    }

}
```

- íŠ¸ëœì­ì…˜ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ìˆëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ ì‹œì‘í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.
- ëŸ°ë° ë¬¸ì œëŠ” íŠ¸ëœì­ì…˜ì„ ìƒìš”í•˜ê¸° ìœ„í•´ì„œ `javax.sql.DataSource`, `java.sql.Connection`, `java.sql.SQLException` ê°™ì€ JDBC ê¸°ìˆ ì— ì˜ì¡´í•´ì•¼ í•œë‹¤ëŠ” ì ì´ë‹¤.
- íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ JDBC ê¸°ìˆ ì— ì˜ì¡´í•œë‹¤. ê²°ê³¼ì ìœ¼ë¡œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë³´ë‹¤ JDBCë¥¼ ì‚¬ìš©í•´ì„œ íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•˜ëŠ” ì½”ë“œê°€ ë” ë§ë‹¤.
- í–¥í›„ JDBCì—ì„œ JPA ê°™ì€ ë‹¤ë¥¸ ê¸°ìˆ ë¡œ ë°”ê¾¸ì–´ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ ì„œë¹„ìŠ¤ ì½”ë“œë„ ëª¨ë‘ í•¨ê»˜ ë³€ê²½í•´ì•¼ í•œë‹¤.
    
    (JPAëŠ” íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ì½”ë“œê°€ JDBCì™€ ë‹¤ë¥´ë‹¤.)
    
- í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ JDBC ê¸°ìˆ ì´ ì„ì—¬ ìˆì–´ì„œ ìœ ì§€ë³´ìˆ˜ í•˜ê¸° ì–´ë µë‹¤.

### ë¬¸ì œ ì •ë¦¬

ì§€ê¸ˆê¹Œì§€ ê°œë°œí•œ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¬¸ì œì ì€ í¬ê²Œ 3ê°€ì§€ì´ë‹¤.

- íŠ¸ëœì­ì…˜ ë¬¸ì œ
- ì˜ˆì™¸ ëˆ„ìˆ˜ ë¬¸ì œ
- JDBC ë°˜ë³µ ë¬¸ì œ

**íŠ¸ëœì­ì…˜ ë¬¸ì œ**

ê°€ì¥ í° ë¬¸ì œëŠ” íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ë©´ì„œ ìƒê¸´ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œë“¤ì´ë‹¤.

- JDBC êµ¬í˜„ ê¸°ìˆ ì´ ì„œë¹„ìŠ¤ ê³„ì¸µì— ëˆ„ìˆ˜ë˜ëŠ” ë¬¸ì œ
    - íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ê¸° ìœ„í•´ JDBC êµ¬í˜„ ê¸°ìˆ ì´ ì„œë¹„ìŠ¤ ê³„ì¸µì— ëˆ„ìˆ˜ë˜ì—ˆë‹¤.
    - ì„œë¹„ìŠ¤ ê³„ì¸µì€ ìˆœìˆ˜í•´ì•¼ í•œë‹¤. â†’ êµ¬í˜„ ê¸°ìˆ ì„ ë³€ê²½í•´ë„ ì„œë¹„ìŠ¤ ê³„ì¸µ ì½”ë“œëŠ” ìµœëŒ€í•œ ìœ ì§€í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤. (ë³€í™”ì— ëŒ€ì‘)
        - ê·¸ë˜ì„œ ë°ì´í„° ì ‘ê·¼ ê³„ì¸µì— JDBC ì½”ë“œë¥¼ ë‹¤ ëª°ì•„ë‘ëŠ” ê²ƒì´ë‹¤.
        - ë¬¼ë¡  ë°ì´í„° ì ‘ê·¼ ê³„ì¸µì˜ êµ¬í˜„ ê¸°ìˆ ì´ ë³€ê²½ë  ìˆ˜ë„ ìˆìœ¼ë‹ˆ ë°ì´í„° ì ‘ê·¼ ê³„ì¸µì€ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.
    - ì„œë¹„ìŠ¤ ê³„ì¸µì€ íŠ¹ì • ê¸°ìˆ ì— ì¢…ì†ë˜ì§€ ì•Šì•„ì•¼ í•œë‹¤. ì§€ê¸ˆê¹Œì§€ ê·¸ë ‡ê²Œ ë…¸ë ¥í•´ì„œ ë°ì´í„° ì ‘ê·¼ ê³„ì¸µìœ¼ë¡œ JDBC ê´€ë ¨ ì½”ë“œë¥¼ ëª¨ì•˜ëŠ”ë°, íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ë©´ì„œ ê²°êµ­ ì„œë¹„ìŠ¤ ê³„ì¸µì— JDBC êµ¬í˜„ ê¸°ìˆ ì˜ ëˆ„ìˆ˜ê°€ ë°œìƒí–ˆë‹¤.
- íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë¬¸ì œ
    - ê°™ì€ íŠ¸ëœì­ì…˜ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ ì»¤ë„¥ì…˜ì„ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê²¨ì•¼ í•œë‹¤.
    - ì´ë•Œ íŒŒìƒë˜ëŠ” ë¬¸ì œë“¤ë„ ìˆë‹¤. ë˜‘ê°™ì€ ê¸°ëŠ¥ë„ íŠ¸ëœì­ì…˜ìš© ê¸°ëŠ¥ê³¼ íŠ¸ëœì­ì…˜ì„ ìœ ì§€í•˜ì§€ ì•Šì•„ë„ ë˜ëŠ” ê¸°ëŠ¥ìœ¼ë¡œ ë¶„ë¦¬í•´ì•¼ í•œë‹¤.
- íŠ¸ëœì­ì…˜ ì ìš© ë°˜ë³µ ë¬¸ì œ
    - íŠ¸ëœì­ì…˜ ì ìš© ì½”ë“œë¥¼ ë³´ë©´ ë°˜ë³µì´ ë§ë‹¤. `try`, `catch`, `finally` â€¦

**ì˜ˆì™¸ ëˆ„ìˆ˜**

- ë°ì´í„° ì ‘ê·¼ ê³„ì¸µì˜ JDBC êµ¬í˜„ ê¸°ìˆ  ì˜ˆì™¸ê°€ ì„œë¹„ìŠ¤ ê³„ì¸µìœ¼ë¡œ ì „íŒŒëœë‹¤.
- `SQLException`ì€ ì²´í¬ ì˜ˆì™¸ì´ê¸° ë•Œë¬¸ì— ë°ì´í„° ì ‘ê·¼ ê³„ì¸µì„ í˜¸ì¶œí•œ ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ í•´ë‹¹ ì˜ˆì™¸ë¥¼ ì¡ì•„ì„œ ì²˜ë¦¬í•˜ê±°ë‚˜ ëª…ì‹œì ìœ¼ë¡œ `throws`ë¥¼ í†µí•´ì„œ ë‹¤ì‹œ ë°–ìœ¼ë¡œ ë˜ì ¸ì•¼í•œë‹¤.
- `SQLException`ì€ JDBC ì „ìš© ê¸°ìˆ ì´ë‹¤. í–¥í›„ JPAë‚˜ ë‹¤ë¥¸ ë°ì´í„° ì ‘ê·¼ ê¸°ìˆ ì„ ì‚¬ìš©í•˜ë©´, ê·¸ì— ë§ëŠ” ë‹¤ë¥¸ ì˜ˆì™¸ë¡œ ë³€ê²½í•´ì•¼ í•˜ê³ , ê²°êµ­ ì„œë¹„ìŠ¤ ì½”ë“œë„ ìˆ˜ì •í•´ì•¼ í•œë‹¤.

**JDBC ë°˜ë³µ ë¬¸ì œ**

- ì§€ê¸ˆê¹Œì§€ ì‘ì„±í•œ `MemberRepository` ì½”ë“œëŠ” ìˆœìˆ˜í•œ JDBCë¥¼ ì‚¬ìš©í–ˆë‹¤.
- ì´ ì½”ë“œë“¤ì€ ìœ ì‚¬í•œ ì½”ë“œì˜ ë°˜ë³µì´ ë„ˆë¬´ ë§ë‹¤.
    - `try`, `catch`, `finally` â€¦
    - ì»¤ë„¥ì…˜ì„ ì—´ê³ , `PreparedStatement`ë¥¼ ì‚¬ìš©í•˜ê³ , ê²°ê³¼ë¥¼ ë§¤í•‘í•˜ê³ .. ì‹¤í–‰í•˜ê³ , ì»¤ë„¥ì…˜ê³¼ ë¦¬ì†ŒìŠ¤ë¥¼ ì •ë¦¬í•œë‹¤.

### ìŠ¤í”„ë§ê³¼ ë¬¸ì œ í•´ê²°

ìŠ¤í”„ë§ì€ ì„œë¹„ìŠ¤ ê³„ì¸µì„ ìˆœìˆ˜í•˜ê²Œ ìœ ì§€í•˜ë©´ì„œ, ì§€ê¸ˆê¹Œì§€ ì´ì•¼ê¸°í•œ ë¬¸ì œë“¤ì„ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë‹¤ì–‘í•œ ë°©ë²•ê³¼ ê¸°ìˆ ë“¤ì„ ì œê³µí•œë‹¤.

ì§€ê¸ˆë¶€í„° ìŠ¤í”„ë§ì„ ì‚¬ìš©í•´ì„œ ìš°ë¦¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ê°€ì§„ ë¬¸ì œë“¤ì„ í•˜ë‚˜ì”© í•´ê²°í•´ë³´ì.

## íŠ¸ëœì­ì…˜ ì¶”ìƒí™”

í˜„ì¬ ì„œë¹„ìŠ¤ ê³„ì¸µì€ íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œ JDBC ê¸°ìˆ ì— ì˜ì¡´í•˜ê³  ìˆë‹¤. í–¥í›„ JDBCì—ì„œ JPA ê°™ì€ ë‹¤ë¥¸ ë°ì´í„° ì ‘ê·¼ ê¸°ìˆ ë¡œ ë³€ê²½í•˜ë©´, ì„œë¹„ìŠ¤ ê³„ì¸µì˜ íŠ¸ëœì­ì…˜ ê´€ë ¨ ì½”ë“œë„ ëª¨ë‘ í•¨ê»˜ ìˆ˜ì •í•´ì•¼ í•œë‹¤.

**êµ¬í˜„ ê¸°ìˆ ì— ë”°ë¥¸ íŠ¸ëœì­ì…˜ ì‚¬ìš©ë²•**

- íŠ¸ëœì­ì…˜ì€ ì›ìì  ë‹¨ìœ„ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•œë‹¤.
- êµ¬í˜„ ê¸°ìˆ ë§ˆë‹¤ íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ ë‹¤ë¥´ë‹¤.
    - JDBC : `con.setAutoCommit(false)`
    - JPA : `transaction.begin()`

**JDBC íŠ¸ëœì­ì…˜ ì½”ë“œ ì˜ˆì‹œ**

```java
public void accountTransfer(String fromId, String toId, int money) throws SQLException {
    Connection con = dataSource.getConnection();
    try {
        con.setAutoCommit(false);  //íŠ¸ëœì­ì…˜ ì‹œì‘
        //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
        bizLogic(con, fromId, toId, money);
        con.commit();  //ì„±ê³µì‹œ ì»¤ë°‹
    } catch (Exception e) {
        con.rollback();  //ì‹¤íŒ¨ì‹œ ë¡ë°±
        throw new IllegalStateException(e);
    } finally {
        release(con);
    }
}
```

**JPA íŠ¸ëœì­ì…˜ ì½”ë“œ ì˜ˆì‹œ**

```java
public static void main(String[] args) {

    //ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ ìƒì„±
    EntityManagerFactory emf = Persistence.createEntityManagerFactory("jpabook");
    EntityManager em = emf.createEntityManager(); //ì—”í‹°í‹° ë§¤ë‹ˆì € ìƒì„± 
    EntityTransaction tx = em.getTransaction(); //íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ íšë“

    try {
        tx.begin(); //íŠ¸ëœì­ì…˜ ì‹œì‘ logic(em); //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ tx.commit();//íŠ¸ëœì­ì…˜ ì»¤ë°‹
    } catch (Exception e) { 
        tx.rollback(); //íŠ¸ëœì­ì…˜ ë¡¤ë°±
    } finally {
        em.close(); //ì—”í‹°í‹° ë§¤ë‹ˆì € ì¢…ë£Œ
    }
    emf.close(); //ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ ì¢…ë£Œ
}
```

íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ì½”ë“œëŠ” ë°ì´í„° ì ‘ê·¼ ê¸°ìˆ ë§ˆë‹¤ ë‹¤ë¥´ë‹¤. ë§Œì•½ ë‹¤ìŒ ê·¸ë¦¼ê³¼ ê°™ì´ JDBC ê¸°ìˆ ì„ ìƒìš”í•˜ê³ , JDBC íŠ¸ëœì­ì…˜ì— ì˜ì¡´í•˜ë‹¤ê°€ JPA ê¸°ìˆ ë¡œ ë³€ê²½í•˜ê²Œ ë˜ë©´ ì„œë¹„ìŠ¤ ê³„ì¸µì˜ íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•˜ë¯ ì½”ë“œë„ ëª¨ë‘ í•¨ê»˜ ë³€ê²½í•´ì•¼ í•œë‹¤.

**JDBC íŠ¸ëœì­ì…˜ ì˜ì¡´**

![Untitled 1](https://github.com/soohyunnn/spring_db_1/assets/58289675/96417ed2-0817-4b4d-a270-ea917f005ce6)

**JDBC ê¸°ìˆ  â†’ JPA ê¸°ìˆ ë¡œ ë³€ê²½**

![Untitled 2](https://github.com/soohyunnn/spring_db_1/assets/58289675/72c11bbc-8f52-423c-a852-9a6c832251c4)

ì´ë ‡ê²Œ JDBC ê¸°ìˆ ì„ ì‚¬ìš©í•˜ë‹¤ê°€ JPA ê¸°ìˆ ë¡œ ë³€ê²½í•˜ê²Œ ë˜ë©´ ì„œë¹„ìŠ¤ ê³„ì¸µì˜ ì½”ë“œë„ JPA ê¸°ìˆ ì„ ì‚¬ìš©í•˜ë„ë¡ í•¨ê»˜ ìˆ˜ì •í•´ì•¼ í•œë‹¤.

**íŠ¸ëœì­ì…˜ ì¶”ìƒí™”**

ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ë©´ íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì„ ì¶”ìƒí™”í•˜ë©´ ëœë‹¤.

ì•„ì£¼ ë‹¨ìˆœí•˜ê²Œ ìƒê°í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ì–´ì„œ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

**íŠ¸ëœì­ì…˜ ì¶”ìƒí™” ì¸í„°í˜ì´ìŠ¤**

```java
public interface TxManager {
    begin();
		commit();
    rollback();
}
```

íŠ¸ëœì­ì…˜ì€ ì‚¬ì‹¤ ë‹¨ìˆœí•˜ë‹¤. íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³ , ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ ìˆ˜í–‰ì´ ëë‚˜ë©´ ì»¤ë°‹í•˜ê±°ë‚˜ ë¡¤ë°±í•˜ë©´ ëœë‹¤.

ê·¸ë¦¬ê³  ë‹¤ìŒê³¼ ê°™ì´ `TxManager` ì¸í„°í˜ì´ìŠ¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê°ê°ì˜ ê¸°ìˆ ì— ë§ëŠ” êµ¬í˜„ì²´ë¥¼ ë§Œë“¤ë©´ ëœë‹¤.

- `JdbcTxManager` : JDBC íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” êµ¬í˜„ì²´
- `JpaTxManager` : JPA íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” êµ¬í˜„ì²´

**íŠ¸ëœì­ì…˜ ì¶”ìƒí™”ì™€ ì˜ì¡´ê´€ê³„**

![Untitled 3](https://github.com/soohyunnn/spring_db_1/assets/58289675/fc707feb-108e-4fe8-b617-dcab159700ce)

- ì„œë¹„ìŠ¤ëŠ” íŠ¹ì • íŠ¸ëœì­ì…˜ ê¸°ìˆ ì— ì§ì ‘ ì˜ì¡´í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, `TxManager`ë¼ëŠ” ì¶”ìƒí™”ëœ ì¸í„°í˜ì´ìŠ¤ì— ì˜ì¡´í•œë‹¤. ì´ì œ ì›í•˜ëŠ” êµ¬í˜„ì²´ë¥¼ DIë¥¼ í†µí•´ì„œ ì£¼ì…í•˜ë©´ ëœë‹¤. ì˜ˆë¥¼ ë“¤ì–´ì„œ JDBC íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì´ í•„ìš”í•˜ë©´ `JdbcTxManager`ë¥¼ ì„œë¹„ìŠ¤ì— ì£¼ì…í•˜ê³ , JPA íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•˜ë©´ `JpaTxManager`ë¥¼ ì£¼ì…í•˜ë©´ ëœë‹¤.
- í´ë¼ì´ì–¸íŠ¸ì¸ ì„œë¹„ìŠ¤ëŠ” ì¸í„°í˜ì´ìŠ¤ì— ì˜ì¡´í•˜ê³  DIë¥¼ ì‚¬ìš©í•œ ë•ë¶„ì— OCP ì›ì¹™ì„ ì§€í‚¤ê²Œ ë˜ì—ˆë‹¤. ì´ì œ íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ì„œë¹„ìŠ¤ ì½”ë“œë¥¼ ì „í˜€ ë³€ê²½í•˜ì§€ ì•Šê³ , íŠ¸ëœì­ì…˜ ê¸°ìˆ ì„ ë³€ê²½í•  ìˆ˜ ìˆë‹¤.

**ìŠ¤í”„ë§ì˜ íŠ¸ëœì­ì…˜ ì¶”ìƒí™”**

ìŠ¤í”„ë§ì€ ì´ë¯¸ ì´ëŸ° ê³ ë¯¼ì„ ë‹¤ í•´ë‘ì—ˆë‹¤. ìš°ë¦¬ëŠ” ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” íŠ¸ëœì­ì…˜ ì¶”ìƒí™” ê¸°ìˆ ì„ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

ì‹¬ì§€ì–´ ë°ì´í„° ì ‘ê·¼ ê¸°ìˆ ì— ë”°ë¥¸ íŠ¸ëœì­ì…˜ êµ¬í˜„ì²´ë„ ëŒ€ë¶€ë¶„ ë§Œë“¤ì–´ë‘ì–´ì„œ ê°€ì ¸ë‹¤ ì‚¬ìš©í•˜ê¸°ë§Œ í•˜ë©´ ëœë‹¤.

![Untitled 4](https://github.com/soohyunnn/spring_db_1/assets/58289675/642a2cd2-6bb8-4332-bf16-170801693e0f)

ìŠ¤í”„ë§ íŠ¸ëœì­ì…˜ ì¶”ìƒí™”ì˜ í•µì‹¬ì€ `PlatformTransactionManager` ì¸í„°í˜ì´ìŠ¤ì´ë‹¤.

- `org.springframework.transaction.PlatformTransactionManager`

> ğŸ’¡Â ì°¸ê³ 
ìŠ¤í”„ë§ 5.3ë¶€í„°ëŠ” JDBC íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬í•  ë•Œ `DataSourceTransactionManager`ë¥¼ ìƒì†ë°›ì•„ì„œ ì•½ê°„ì˜ ê¸°ëŠ¥ì„ í™•ì¥í•œ `JdbcTransactionManager`ë¥¼ ì œê³µí•œë‹¤. ë‘˜ì˜ ê¸°ëŠ¥ ì°¨ì´ëŠ” í¬ì§€ ì•Šìœ¼ë¯€ë¡œ ê°™ì€ ê²ƒìœ¼ë¡œ ì´í•´í•˜ë©´ ëœë‹¤.
> 

**PlatformTransactionManager ì¸í„°í˜ì´ìŠ¤**

```java
package org.springframework.transaction;

public interface PlatformTransactionManager extends TransactionManager {

  TransactionStatus getTransaction(@Nullable TransactionDefinition definition)
          throws TransactionException;

  void commit(TransactionStatus status) throws TransactionException;
  void rollback(TransactionStatus status) throws TransactionException;
}
```

- `getTransaction()` : íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•œë‹¤.
    - ì´ë¦„ì´ `getTransaction()`ì¸ ì´ìœ ëŠ” ê¸°ì¡´ì— ì´ë¯¸ ì§„í–‰ì¤‘ì¸ íŠ¸ëœì­ì…˜ì´ ìˆëŠ” ê²½ìš° í•´ë‹¹ íŠ¸ëœì­ì…˜ì— ì°¸ì—¬í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤.
    - ì°¸ê³ ë¡œ íŠ¸ëœì­ì…˜ ì°¸ì—¬, ì „íŒŒì— ëŒ€í•œ ë¶€ë¶„ì€ ë’¤ì—ì„œ ì„¤ëª…í•œë‹¤. ì§€ê¸ˆì€ ë‹¨ìˆœíˆ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ëŠ” ê²ƒìœ¼ë¡œ ì´í•´í•˜ë©´ ëœë‹¤.
- `commit()` : íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•œë‹¤.
- `rollback()` : íŠ¸ëœì­ì…˜ì„ ë¡¤ë°±í•œë‹¤.

ì•ìœ¼ë¡œ `PlatformTransactionManager` ì¸í„°í˜ì´ìŠ¤ì™€ êµ¬í˜„ì²´ë¥¼ í¬í•¨í•´ì„œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¡œ ì¤„ì—¬ì„œ ì´ì•¼ê¸°í•  ê²ƒì´ë‹ˆ ì°¸ê³  ë°”ë€ë‹¤.

## íŠ¸ëœì­ì…˜ ë™ê¸°í™”

ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ëŠ” í¬ê²Œ 2ê°€ì§€ ì—­í• ì„ í•œë‹¤.

- íŠ¸ëœì­ì…˜ ì¶”ìƒí™”
- ë¦¬ì†ŒìŠ¤ ë™ê¸°í™”

**íŠ¸ëœì­ì…˜ ì¶”ìƒí™”**

íŠ¸ëœì­ì…˜ ê¸°ìˆ ì„ ì¶”ìƒí™” í•˜ëŠ” ë¶€ë¶„ì€ ì•ì—ì„œ ì„¤ëª…í–ˆë‹¤.

**ë¦¬ì†ŒìŠ¤ ë™ê¸°í™”**

íŠ¸ëœì­ì…˜ì„ ìœ ì§€í•˜ë ¤ë©´ íŠ¸ëœì­ì…˜ì˜ ì‹œì‘ë¶€í„° ëê¹Œì§€ ê°™ì€ ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ì„ ìœ ì§€í•´ì•¼í•œë‹¤. ê²°êµ­ ê°™ì€ ì»¤ë„¥ì…˜ì„ ë™ê¸°í™”(ë§ì¶”ì–´ ì‚¬ìš©)í•˜ê¸° ìœ„í•´ì„œ ì´ì „ì—ëŠ” íŒŒë¼ë¯¸í„°ë¡œ ì»¤ë„¥ì…˜ì„ ì „ë‹¬í•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©í–ˆë‹¤. 
íŒŒë¼ë¯¸í„°ë¡œ ì»¤ë„¥ì…˜ì„ ì „ë‹¬í•˜ëŠ” ë°©ë²•ì€ ì½”ë“œê°€ ì§€ì €ë¶„í•´ì§€ëŠ” ê²ƒì€ ë¬¼ë¡ ì´ê³ , ì»¤ë„¥ì…˜ì„ ë„˜ê¸°ëŠ” ë©”ì„œë“œì™€ ë„˜ê¸°ì§€ ì•ŠëŠ” ë©”ì„œë“œë¥¼ ì¤‘ë³µí•´ì„œ ë§Œë“¤ì–´ì•¼ í•˜ëŠ” ë“± ì—¬ëŸ¬ê°€ì§€ ë‹¨ì ë“¤ì´ ë§ë‹¤.

**ì»¤ë„¥ì…˜ê³¼ ì„¸ì…˜**

![Untitled 5](https://github.com/soohyunnn/spring_db_1/assets/58289675/f27ad617-768e-46c7-8b6f-f89e56df70e7)

**íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ì™€ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €**

![Untitled 6](https://github.com/soohyunnn/spring_db_1/assets/58289675/161c7d4a-01a6-4f27-8cf0-d4e984cd6570)

- ìŠ¤í”„ë§ì€ **íŠ¸ëœì¬ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €**ë¥¼ ì œê³µí•œë‹¤. ì´ê²ƒì€ ì“°ë ˆë“œ ë¡œì»¬(`ThreadLocal`)ì„ ì‚¬ìš©í•´ì„œ ì»¤ë„¥ì…˜ì„ ë™ê¸°í™”í•´ì¤€ë‹¤. íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ëŠ” ë‚´ë¶€ì—ì„œ ì´ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ë¥¼ ì‚¬ìš©í•œë‹¤.
- íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ëŠ” ì“°ë ˆë“œ ë¡œì»¬ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ë©€í‹°ì“°ë ˆë“œ ìƒí™©ì— ì•ˆì „í•˜ê²Œ ì»¤ë„¥ì…˜ì„ ë™ê¸°í™” í•  ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ ì»¤ë„¥ì…˜ì´ í•„ìš”í•˜ë©´ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ë¥¼ í†µí•´ ì»¤ë„¥ì…˜ì„ íšë“í•˜ë©´ ëœë‹¤. ë”°ë¼ì„œ ì´ì „ì²˜ëŸ¼ íŒŒë¼ë¯¸í„°ë¡œ ì»¤ë„¥ì…˜ì„ ì „ë‹¬í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

**ë™ì‘ ë°©ì‹ì„ ê°„ë‹¨í•œê²Œ ì„¤ëª…í•˜ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.**

1. íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ë ¤ë©´ ì»¤ë„¥ì…˜ì´ í•„ìš”í•˜ë‹¤. íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ëŠ” ë°ì´í„°ì†ŒìŠ¤ë¥¼ í†µí•´ ì»¤ë„¥ì…˜ì„ ë§Œë“¤ê³  íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•œë‹¤.
2. íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ëŠ” íŠ¸ëœì­ì…˜ì´ ì‹œì‘ëœ ì»¤ë„¥ì…˜ì„ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ì— ë³´ê´€í•œë‹¤.
3. ë¦¬í¬ì§€í† ë¦¬ëŠ” íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ì— ë³´ê´€ëœ ì»¤ë„¥ì…˜ì„ êº¼ë‚´ì„œ ì‚¬ìš©í•œë‹¤. ë”°ë¼ì„œ íŒŒë¼ë¯¸í„°ë¡œ ì»¤ë„¥ì…˜ì„ ì „ë‹¬í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.
4. íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë˜ë©´ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ëŠ” íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ì— ë³´ê´€ëœ ì»¤ë„¥ì…˜ì„ í†µí•´ íŠ¸ëœì­ì…˜ì„ ì¢…ë£Œí•˜ê³ , ì»¤ë„¥ì…˜ë„ ë‹«ëŠ”ë‹¤.

**íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €**

ë‹¤ìŒ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì € í´ë˜ìŠ¤ë¥¼ ì—´ì–´ë³´ë©´ ì“°ë ˆë“œ ë¡œì»¬ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

`org.springframework.transaction.support.TransactionSynchronizationManager`

> ğŸ’¡Â ì°¸ê³ 
ì“°ë ˆë“œ ë¡œì»¬ì„ ì‚¬ìš©í•˜ë©´ ê°ê°ì˜ ì“°ë ˆë“œë§ˆë‹¤ ë³„ë„ì˜ ì €ì¥ì†Œê°€ ë¶€ì—¬ëœë‹¤. ë”°ë¼ì„œ í•´ë‹¹ ì“°ë ˆë“œë§Œ í•´ë‹¹ ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.
ì“°ë ˆë“œ ë¡œì»¬ì— ëŒ€í•œ ìì„¸í•œ ë‚˜ìš©ì€ **ìŠ¤í”„ë§ í•µì‹¬ ì›ë¦¬ - ê³ ê¸‰í¸** ê°•ì˜ë¥¼ ì°¸ê³ í•˜ì.
> 

## íŠ¸ëœì­ì…˜ ë¬¸ì œ í•´ê²° - íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €1

ì´ì œ ë³¸ê²©ì ìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œì— íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì ìš©í•´ë³´ì.

**MemberRepositoryV3**

```java
package hello.jdbc.repository;

import hello.jdbc.domain.Member;
import lombok.extern.slf4j.Slf4j;
import org.springframework.jdbc.datasource.DataSourceUtils;
import org.springframework.jdbc.support.JdbcUtils;

import javax.sql.DataSource;
import java.sql.*;
import java.util.NoSuchElementException;

/**
 * íŠ¸ëœì­ì…˜ - íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €
 * DataSourceUtils.getConnection()
 * DataSourceUtils.releaseConnection()
 */
@Slf4j
public class MemberRepositoryV3 {

    private final DataSource dataSource;

    public MemberRepositoryV3(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    public Member save(Member member) throws SQLException {

        String sql = "insert into member(member_id, money) values(?, ?)";

        Connection con = null;
        PreparedStatement pstmt = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1, member.getMemberId());
            pstmt.setInt(2, member.getMoney());
            pstmt.executeUpdate();
            return member;
        } catch (SQLException e) {
            log.error("db error", e);
            throw e;
        } finally {
            close(con, pstmt, null);
        }

    }

    public Member findById(String memberId) throws SQLException {
        String sql = "select * from member where member_id = ?";

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1, memberId);

            rs = pstmt.executeQuery();

            if (rs.next()) {
                Member member = new Member();
                member.setMemberId(rs.getString("member_id"));
                member.setMoney(rs.getInt("money"));
                return member;
            } else {
                throw new NoSuchElementException("member not found memberId=" + memberId);
            }
        } catch (SQLException e) {
            log.error("db error", e);
            throw e;
        } finally {
            close(con, pstmt, rs);
        }

    }

    public void update(String memberId, int money) throws SQLException {
        String sql = "update member set money = ? where member_id = ?";

        Connection con = null;
        PreparedStatement pstmt = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setInt(1, money);
            pstmt.setString(2, memberId);
            int resultSize = pstmt.executeUpdate();
            log.info("resultSize={}", resultSize);
        } catch (SQLException e) {
            log.error("db error", e);
            throw e;
        } finally {
            close(con, pstmt, null);
        }

    }

    public void delete(String memberId) throws SQLException {
        String sql = "delete from member where member_id = ?";

        Connection con = null;
        PreparedStatement pstmt = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1, memberId);

            pstmt.executeUpdate();

        } catch (SQLException e) {
            log.error("db error", e);
            throw e;
        } finally {
            close(con, pstmt, null);
        }
    }

    private void close(Connection con, Statement stmt, ResultSet rs) {
        JdbcUtils.closeResultSet(rs);
        JdbcUtils.closeStatement(stmt);
        **//ì£¼ì˜! íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ DataSourceUtrilsë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
        DataSourceUtils.releaseConnection(con, dataSource);**
    }

    private Connection getConnection() throws SQLException {
        **//ì£¼ì˜! íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ DataSourceUtils ì‚¬ìš©í•´ì•¼ í•œë‹¤.
        Connection con = DataSourceUtils.getConnection(dataSource);**
        log.info("get connection={}, class={}", con, con.getClass());
        return con;
    }

}
```

ì»¤ë„¥ì…˜ì„ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•˜ëŠ” ë¶€ë¶„ì´ ëª¨ë‘ ì œê±°ë˜ì—ˆë‹¤.

**DataSourceUtils.getConnection()**

- `getConnection()`ì—ì„œ `DataSourceUtils.getConnection()`ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½ëœ ë¶€ë¶„ì„ íŠ¹íˆ ì£¼ì˜í•´ì•¼ í•œë‹¤.
- `DataSourceUtils.getConnection()`ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë™ì‘í•œë‹¤.
    - **íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ê°€ ê´€ë¦¬í•˜ëŠ” ì»¤ë„¥ì…˜ì´ ìˆìœ¼ë©´ í•´ë‹¹ ì»¤ë„¥ì…˜ì„ ë°˜í™˜í•œë‹¤.**
    - íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ê°€ ê´€ë¦¬í•˜ëŠ” ì»¤ë„¥ì…˜ì´ ì—†ëŠ” ê²½ìš° ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì„ ìƒì„±í•´ì„œ ë°˜í™˜í•œë‹¤.

**DataSourceUtils.releaseConnection()**

- `close()`ì—ì„œ `DataSourceUtils.releaseConnection()`ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½ëœ ë¶€ë¶„ì„ íŠ¹íˆ ì£¼ì˜í•´ì•¼í•œë‹¤. ì»¤ë„¥ì…˜ì„ `con.close()`ë¥¼ ì‚¬ìš©í•´ì„œ ì§ì ‘ ë‹«ì•„ë²„ë¦¬ë©´ ì»¤ë„¥ì…˜ì´ ìœ ì§€ë˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ë°œìƒí•œë‹¤. ì´ ì»¤ë„¥ì…˜ì€ ì´í›„ ë¡œì§ì€ ë¬¼ë¡ ì´ê³ , íŠ¸ëœì­ì…˜ì„ ì¢…ë£Œ(ì»¤ë°‹, ë¡¤ë°±)í•  ë•Œ ê¹Œì§€ ì‚´ì•„ìˆì–´ì•¼ í•œë‹¤.
- `DataSourceUtils.releaseConnection()`ì„ ì‚¬ìš©í•˜ë©´ ì»¤ë„¥ì…˜ì„ ë°”ë¡œ ë‹«ëŠ” ê²ƒì´ ì•„ë‹ˆë‹¤.
    - **íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë™ê¸°í™”ëœ ì»¤ë„¥ì…˜ì€ ì»¤ë„¥ì…˜ì„ ë‹«ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ìœ ì§€í•´ì¤€ë‹¤.**
    - íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ê°€ ê´€ë¦¬í•˜ëŠ” ì»¤ë„¥ì…˜ì´ ì—†ëŠ” ê²½ìš° í•´ë‹¹ ì»¤ë„¥ì…˜ì„ ë‹«ëŠ”ë‹¤.

ì´ì œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì‚¬ìš©í•˜ëŠ” ì„œë¹„ìŠ¤ ì½”ë“œë¥¼ ì‘ì„±í•´ë³´ì.

**MemberServiceV3_1**

```java
package hello.jdbc.service;

import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepositoryV2;
import hello.jdbc.repository.MemberRepositoryV3;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.TransactionStatus;
import org.springframework.transaction.support.DefaultTransactionDefinition;

import javax.sql.DataSource;
import java.sql.Connection;
import java.sql.SQLException;

/**
 * íŠ¸ëœì­ì…˜ - íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €
 */
@Slf4j
@RequiredArgsConstructor
public class MemberServiceV3_1 {

    private final PlatformTransactionManager transactionManager;
    private final MemberRepositoryV3 memberRepository;

    public void accountTransfer(String fromId, String toId, int money) throws SQLException {

        //íŠ¸ëœì­ì…˜ ì‹œì‘
        TransactionStatus status = transactionManager.getTransaction(new DefaultTransactionDefinition());

        try {
            //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
            bizLogic(fromId, toId, money);
            transactionManager.commit(status);  //ì„±ê³µì‹œ ì»¤ë°‹
        } catch (Exception e) {
            transactionManager.rollback(status);  //ì‹¤íŒ¨ì‹œ ë¡¤ë°±
            throw new IllegalStateException(e);
        }
    }

    private void bizLogic(String fromId, String toId, int money) throws  SQLException {
        Member fromMember = memberRepository.findById(fromId);
        Member toMember = memberRepository.findById(toId);

        memberRepository.update(fromId, fromMember.getMoney() - money);
        memberRepository.update(toId, toMember.getMoney() + money);

    }

    private void validation(Member toMember) {
        if (toMember.getMemberId().equals("ex")) {
            throw new IllegalStateException("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ");
        }
    }

}
```

- `private final PlatformTransactionManager transactionManager`
    - íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì£¼ì… ë°›ëŠ”ë‹¤. ì§€ê¸ˆì€ JDBC ê¸°ìˆ ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— DataSourceTransactionManager êµ¬í˜„ì²´ë¥¼ ì£¼ì… ë°›ì•„ì•¼ í•œë‹¤.
    - ë¬¼ë¡  JPA ê°™ì€ ê¸°ìˆ ë¡œ ë³€ê²½ë˜ë©´ JpaTransactionManagerë¥¼ ì£¼ì… ë°›ìœ¼ë©´ ëœë‹¤.
- `transactionManager.getTransaction()`
    - íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•œë‹¤.
    - TransactionStatus statusë¥¼ ë°˜í™˜í•œë‹¤. í˜„ì¬ íŠ¸ëœì­ì…˜ì˜ ìƒíƒœ ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆë‹¤. ì´í›„ íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹,ë¡¤ë°±í•  ë•Œ í•„ìš”í•˜ë‹¤.
- `new DefaultTransactionDefinition()`
    - íŠ¸ëœì­ì…˜ê³¼ ê´€ë ¨ëœ ì˜µì…˜ì„ ì§€ì •í•  ìˆ˜ ìˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ë’¤ì—ì„œ ì„¤ëª…í•œë‹¤.
- `transactionManager.commit(status)`
    - íŠ¸ëœì­ì…˜ì´ ì„±ê³µí•˜ë©´ ì´ ë¡œì§ì„ í˜¸ì¶œí•´ì„œ ì»¤ë°‹í•˜ë©´ ëœë‹¤.
- `transactionManager.rollback(status)`
    - ë¬¸ì œê°€ ë°œìƒí•˜ë©´ ì´ ë¡œì§ì„ í˜¸ì¶œí•´ì„œ íŠ¸ëœì­ì…˜ì„ ë¡¤ë°±í•˜ë©´ ëœë‹¤.

**MemberServiceV3_1Test**

```java
package hello.jdbc.service;

import hello.jdbc.connection.ConnectionConst;
import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepositoryV3;
import org.assertj.core.api.Assertions;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.jdbc.datasource.DataSourceTransactionManager;
import org.springframework.jdbc.datasource.DriverManagerDataSource;
import org.springframework.transaction.PlatformTransactionManager;

import java.sql.SQLException;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.junit.jupiter.api.Assertions.*;

/**
 * íŠ¸ëœì­ì…˜ - íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €
 */
class MemberServiceV3_1Test {

    public static final String MEMBER_A = "memberA";
    public static final String MEMBER_B = "memberB";
    public static final String MEMBER_EX = "ex";

    private MemberRepositoryV3 memberRepository;
    private MemberServiceV3_1 memberService;

    @BeforeEach
    void before() {
        DriverManagerDataSource dataSource = new DriverManagerDataSource(ConnectionConst.URL, ConnectionConst.USERNAME, ConnectionConst.PASSWORD);
        PlatformTransactionManager transactionManager = new DataSourceTransactionManager(dataSource);

        memberRepository = new MemberRepositoryV3(dataSource);
        memberService = new MemberServiceV3_1(transactionManager, memberRepository);
    }

    @AfterEach
    void after() throws SQLException {
        memberRepository.delete(MEMBER_A);
        memberRepository.delete(MEMBER_B);
        memberRepository.delete(MEMBER_EX);
    }

    @Test
    @DisplayName("ì •ìƒ ì´ì²´")
    void accountTransfer() throws SQLException {
        //given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberB = new Member(MEMBER_B, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberB);

        //when
        memberService.accountTransfer(memberA.getMemberId(), memberB.getMemberId(), 2000);

        //then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberB = memberRepository.findById(memberB.getMemberId());
        assertThat(findMemberA.getMoney()).isEqualTo(8000);
        assertThat(findMemberB.getMoney()).isEqualTo(12000);
    }

    @Test
    @DisplayName("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ")
    void accountTransferEx() throws SQLException {
        //given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberEx = new Member(MEMBER_EX, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberEx);

        //when
        assertThatThrownBy(() -> memberService.accountTransfer(memberA.getMemberId(), memberEx.getMemberId(), 2000))
                .isInstanceOf(IllegalStateException.class);

        //then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberEx = memberRepository.findById(memberEx.getMemberId());

        //memberAì˜ ëˆì´ ë¡¤ë°± ë˜ì–´ì•¼í•¨
        assertThat(findMemberA.getMoney()).isEqualTo(10000);
        assertThat(findMemberEx.getMoney()).isEqualTo(10000);
    }

}
```

**ì´ˆê¸°í™” ì½”ë“œ ì„¤ëª…**

```java
@BeforeEach
void before() {
    DriverManagerDataSource dataSource = new DriverManagerDataSource(ConnectionConst.URL, ConnectionConst.USERNAME, ConnectionConst.PASSWORD);
    PlatformTransactionManager transactionManager = new DataSourceTransactionManager(dataSource);

    memberRepository = new MemberRepositoryV3(dataSource);
    memberService = new MemberServiceV3_1(transactionManager, memberRepository);
}
```

- `new DataSourceTransactionManager(dataSource)`
    - JDBC ê¸°ìˆ ì„ ì‚¬ìš©í•˜ë¯€ë¡œ, JDBCìš© íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €(`DataSourceTransactionManager`)ë¥¼ ì„ íƒí•´ì„œ ì„œë¹„ìŠ¤ì— ì£¼ì…í•œë‹¤.
    - íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ëŠ” ë°ì´í„°ì†ŒìŠ¤ë¥¼ í†µí•´ ì»¤ë„¥ì…˜ì„ ìƒì„±í•˜ë¯€ë¡œ `DataSource`ê°€ í•„ìš”í•˜ë‹¤.
    

í…ŒìŠ¤íŠ¸ í•´ë³´ë©´ ëª¨ë“  ê²°ê³¼ê°€ ì •ìƒ ë™ì‘í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ë‹¹ì—°íˆ ë¡¤ë°± ê¸°ëŠ¥ë„ ì˜ ë™ì‘í•œë‹¤.

## íŠ¸ëœì­ì…˜ ë¬¸ì œ í•´ê²° - íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €2

ê·¸ë¦¼ìœ¼ë¡œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ì˜ ì „ì²´ ë™ì‘ íë¦„ì„ ìì„¸íˆ ì´í•´í•´ë³´ì.

**íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €1 - íŠ¸ëœì­ì…˜ ì‹œì‘**

![Untitled 7](https://github.com/soohyunnn/spring_db_1/assets/58289675/c1317312-2a31-4fc6-ab74-021727528712)

í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ìœ¼ë¡œ ì„œë¹„ìŠ¤ ë¡œì§ì„ ì‹¤í–‰í•œë‹¤.

1. ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ `transactionManager.getTransaction()`ì„ í˜¸ì¶œí•´ì„œ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•œë‹¤.
2. íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ë ¤ë©´ ë¨¼ì € ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ì´ í•„ìš”í•˜ë‹¤. íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ëŠ” ë‚´ë¶€ì—ì„œ ë°ì´í„°ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•´ì„œ ì»¤ë„¥ì…˜ì„ ìƒì„±í•œë‹¤.
3. ì»¤ë„¥ì…˜ì„ ìˆ˜ë™ ì»¤ë°‹ ëª¨ë“œë¡œ ë³€ê²½í•´ì„œ ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•œë‹¤.
4. ì»¤ë„¥ì…˜ì„ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ì— ë³´ê´€í•œë‹¤.
5. íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ëŠ” ì“°ë ˆë“œ ë¡œì»¬ì— ì»¤ë„¥ì…˜ì„ ë³´ê´€í•œë‹¤. ë”°ë¼ì„œ ë©€í‹° ì“°ë ˆë“œ í™˜ê²½ì— ì•ˆì „í•˜ê²Œ ì»¤ë„¥ì…˜ì„ ë³´ê´€í•  ìˆ˜ ìˆë‹¤.

**íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €2 - ë¡œì§ ì‹¤í–‰**

![Untitled 8](https://github.com/soohyunnn/spring_db_1/assets/58289675/da67b81d-6a07-46dc-8649-e61ef86b4526)

1. ì„œë¹„ìŠ¤ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì‹¤í–‰í•˜ë©´ì„œ ë¦¬í¬ì§€í† ë¦¬ì˜ ë©”ì„œë“œë“¤ì„ í˜¸ì¶œí•œë‹¤. ì´ë•Œ ì»¤ë„¥ì…˜ì„ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•˜ì§€ ì•ŠëŠ”ë‹¤.
2. ë¦¬í¬ì§€í† ë¦¬ ë©”ì„œë“œë“¤ì€ íŠ¸ëœì­ì…˜ì´ ì‹œì‘ëœ ì»¤ë„¥ì…˜ì´ í•„ìš”í•˜ë‹¤. ë¦¬í¬ì§€í† ë¦¬ëŠ” DataSourceUtils.getConnection()ì„ ì‚¬ìš©í•´ì„œ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ì— ë³´ê´€ëœ ì»¤ë„¥ì…˜ì„ êº¼ë‚´ì„œ ì‚¬ìš©í•œë‹¤. ì´ ê³¼ì •ì„ í†µí•´ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ê°™ì€ ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•˜ê³ , íŠ¸ëœì­ì…˜ë„ ìœ ì§€ëœë‹¤.
3. íšë“í•œ ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•´ì„œ SQLì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì „ë‹¬í•´ì„œ ì‹¤í–‰í•œë‹¤.

**íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €3 - íŠ¸ëœì­ì…˜ ì¢…ë£Œ**

![Untitled 9](https://github.com/soohyunnn/spring_db_1/assets/58289675/b4f21979-d63b-4e16-8d57-5fc5640f162a)

1. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ëë‚˜ê³  íŠ¸ëœì­ì…˜ì„ ì¢…ë£Œí•œë‹¤. íŠ¸ëœì­ì…˜ì€ ì»¤ë°‹í•˜ê±°ë‚˜ ë¡¤ë°±í•˜ë©´ ì¢…ë£Œëœë‹¤.
2. íŠ¸ëœì­ì…˜ì„ ì¢…ë£Œí•˜ë ¤ë©´ ë™ê¸°í™”ëœ ì»¤ë„¥ì…˜ì´ í•„ìš”í•˜ë‹¤. íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ë¥¼ í†µí•´ ë™ê¸°í™”ëœ ì»¤ë„¥ì…˜ì„ íšë“í•œë‹¤.
3. íšë“í•œ ì»¤ë„¥ì…˜ì„ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ì— íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•˜ê±°ë‚˜ ë¡¤ë°±í•œë‹¤.
4. ì „ì²´ ë¦¬ì†ŒìŠ¤ë¥¼ ì •ë¦¬í•œë‹¤.
    - íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ë¥¼ ì •ë¦¬í•œë‹¤. ì“°ë ˆë“œ ë¡œì»¬ì€ ì‚¬ìš©í›„ ê¼­ ì •ë¦¬í•´ì•¼ í•œë‹¤.
    - `con.setAutoCommit(true)`ë¡œ ë˜ëŒë¦°ë‹¤. ì»¤ë„¥ì…˜ í’€ì„ ê³ ë ¤í•´ì•¼ í•œë‹¤.
    - `con.close()`ë¥¼ í˜¸ì¶œí•´ì„œ ì»¤ë„¥ì…˜ì„ ì¢…ë£Œí•œë‹¤. ì»¤ë„¥ì…˜ í’€ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš° `con.close()`ë¥¼ í˜¸ì¶œí•˜ë©´ ì»¤ë„¥ì…˜ í’€ì— ë°˜í™˜ëœë‹¤.

**ì •ë¦¬**

- íŠ¸ëœì­ì…˜ ì¶”ìƒí™” ë•ë¶„ì— ì„œë¹„ìŠ¤ ì½”ë“œëŠ” ì´ì œ JDBC ê¸°ìˆ ì— ì˜ì¡´í•˜ì§€ ì•ŠëŠ”ë‹¤.
    - ì´í›„ JDBCì—ì„œ JPAë¡œ ë³€ê²½í•´ë„ ì„œë¹„ìŠ¤ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€í•  ìˆ˜ ìˆë‹¤.
    - ê¸°ìˆ  ë³€ê²½ì‹œ ì˜ì¡´ê´€ê³„ ì£¼ì…ë§Œ `DataSourceTransactionManager`ì—ì„œ `JpaTransactionManager`ë¡œ ë³€ê²½í•´ì£¼ë©´ ëœë‹¤.
    - `java.sql.SQLException`ì´ ì•„ì§ ë‚¨ì•„ìˆì§€ë§Œ ì´ ë¶€ë¶„ì€ ë’¤ì— ì˜ˆì™¸ ë¬¸ì œì—ì„œ í•´ê²°í•˜ì.
- íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì € ë•ë¶„ì— ì»¤ë„¥ì…˜ì„ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê¸°ì§€ ì•Šì•„ë„ ëœë‹¤.

> ğŸ’¡Â ì°¸ê³ 
ì—¬ê¸°ì„œëŠ” `DataSourceTransactionManager`ì˜ ë™ì‘ ë°©ì‹ì„ ìœ„ì£¼ë¡œ ì„¤ëª…í–ˆë‹¤. ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ëŠ” í•´ë‹¹ ê¸°ìˆ ì— ë§ë„ë¡ ë³€í˜•ë˜ì–´ì„œ ë™ì‘í•œë‹¤.
> 

## íŠ¸ëœì­ì…˜ ë¬¸ì œ í•´ê²° - íŠ¸ëœì­ì…˜ í…œí”Œë¦¿

íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ë¡œì§ì„ ì‚´í´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì€ íŒ¨í„´ì´ ë°˜ë³µë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

**íŠ¸ëœì­ì…˜ ì‚¬ìš© ì½”ë“œ**

```java
//íŠ¸ëœì­ì…˜ ì‹œì‘
TransactionStatus status = transactionManager.getTransaction(new DefaultTransactionDefinition());

try {
    //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
    bizLogic(fromId, toId, money);
    transactionManager.commit(status);  //ì„±ê³µì‹œ ì»¤ë°‹
} catch (Exception e) {
    transactionManager.rollback(status);  //ì‹¤íŒ¨ì‹œ ë¡¤ë°±
    throw new IllegalStateException(e);
}
```

- íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³ , ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì‹¤í–‰í•˜ê³ , ì„±ê³µí•˜ë©´ ì»¤ë°‹í•˜ê³ , ì˜ˆì™¸ê°€ ë°œìƒí•´ì„œ ì‹¤íŒ¨í•˜ë©´ ë¡¤ë°±í•œë‹¤.
- ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì—ì„œ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ë ¤ë©´ `try`, `catch`, `finally`ë¥¼ í¬í•¨í•œ ì„±ê³µì‹œ ì»¤ë°‹, ì‹¤íŒ¨ì‹œ ë¡¤ë°± ì½”ë“œê°€ ë°˜ë³µë  ê²ƒì´ë‹¤.
- ì´ëŸ° í˜•íƒœëŠ” ê°ê°ì˜ ì„œë¹„ìŠ¤ì—ì„œ ë°˜ë³µëœë‹¤. ë‹¬ë¼ì§€ëŠ” ë¶€ë¶„ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë¿ì´ë‹¤.
- ì´ëŸ´ ë•Œ í…œí”Œë¦¿ ì½œë°± íŒ¨í„´ì„ í™œìš©í•˜ë©´ ì´ëŸ° ë°˜ë³µ ë¬¸ì œë¥¼ ê¹”ë”í•˜ê²Œ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

> ğŸ’¡Â ì°¸ê³ 
í…œí”Œë¦¿ ì½œë°± íŒ¨í„´ì— ëŒ€í•´ì„œ ì§€ê¸ˆì€ ìì„¸íˆ ì´í•´í•˜ì§€ ëª»í•´ë„ ê´œì°®ë‹¤. ìŠ¤í”„ë§ì´ `TransactionTemplate` ì´ë¼ëŠ” í¸ë¦¬í•œ ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” êµ¬ë‚˜ ì •ë„ë¡œ ì´í•´í•´ë„ ëœë‹¤. í…œí”Œë¦¿ ì½œë°± íŒ¨í„´ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ **ìŠ¤í”„ë§ í•µì‹¬ ì›ë¦¬ - ê³ ê¸‰í¸** ê°•ì˜ë¥¼ ì°¸ê³ í•˜ì.
> 

**íŠ¸ëœì­ì…˜ í…œí”Œë¦¿**

í…œí”Œë¦¿ ì½œë°± íŒ¨í„´ì„ ì ìš©í•˜ë ¤ë©´ í…œí”Œë¦¿ì„ ì œê³µí•˜ëŠ” í´ë˜ìŠ¤ë¥¼ ì‘ì„±í•´ì•¼ í•˜ëŠ”ë°, ìŠ¤í”Œì´ì€ `TransactionTemplate`ë¼ëŠ” í…œí”Œë¦¿ í´ë˜ìŠ¤ë¥¼ ì œê³µí•œë‹¤.

**TransactionTemplate**

```java
public class TransactionTemplate {

    private PlatformTransactionManager transactionManager;

    public <T> T execute(TransactionCallback<T> action){..}
    void executeWithoutResult(Consumer<TransactionStatus> action){..}

}
```

- `execute()` : ì‘ë‹µ ê°’ì´ ìˆì„ ë•Œ ì‚¬ìš©í•œë‹¤.
- `executeWithoutResult()` : ì‘ë‹µ ê°’ì´ ì—†ì„ ë•Œ ì‚¬ìš©í•œë‹¤.

íŠ¸ëœì­ì…˜ í…œí”Œë¦¿ì„ ì‚¬ìš©í•´ì„œ ë°˜ë³µí•˜ëŠ” ë¶€ë¶„ì„ ì œê±°í•´ë³´ì.

**MemberServiceV3_2**

```java
package hello.jdbc.service;

import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepositoryV3;
import lombok.extern.slf4j.Slf4j;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.support.TransactionTemplate;

import java.sql.SQLException;

/**
 * íŠ¸ëœì­ì…˜ - íŠ¸ëœì­ì…˜ í…œí”Œë¦¿
 */
@Slf4j
public class MemberServiceV3_2 {

    private final TransactionTemplate txTemplate;
    private final MemberRepositoryV3 memberRepository;

    public MemberServiceV3_2(PlatformTransactionManager transactionManager, MemberRepositoryV3 memberRepository) {
        this.txTemplate = new TransactionTemplate(transactionManager);
        this.memberRepository = memberRepository;
    }

    public void accountTransfer(String fromId, String toId, int money) throws SQLException {

        txTemplate.executeWithoutResult((status) -> {
            try {
                //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
                bizLogic(fromId, toId, money);
            } catch (SQLException e) {
                throw new IllegalStateException(e);
            }
        });

    }

    private void bizLogic(String fromId, String toId, int money) throws  SQLException {
        Member fromMember = memberRepository.findById(fromId);
        Member toMember = memberRepository.findById(toId);

        memberRepository.update(fromId, fromMember.getMoney() - money);
        memberRepository.update(toId, toMember.getMoney() + money);

    }

    private void validation(Member toMember) {
        if (toMember.getMemberId().equals("ex")) {
            throw new IllegalStateException("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ");
        }
    }

}
```

- `TransactionTemplate`ì„ ì‚¬ìš©í•˜ë ¤ë©´ `transactionManager`ê°€ í•„ìš”í•˜ë‹¤. ìƒì„±ìì—ì„œ `transactionManager`ë¥¼ ì£¼ì… ë°›ìœ¼ë©´ì„œ `TransactionTemplate`ë¥¼ ìƒì„±í–ˆë‹¤.

**íŠ¸ëœì­ì…˜ í…œí”Œë¦¿ ì‚¬ìš© ë¡œì§**

```java
txTemplate.executeWithoutResult((status) -> {
    try {
        //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
        bizLogic(fromId, toId, money);
    } catch (Exception e) {
        throw new IllegalStateException(e);
    }
});
```

- íŠ¸ëœì­ì…˜ í…œí”Œë¦¿ ë•ë¶„ì— íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³ , ì»¤ë°‹í•˜ê±°ë‚˜ ë¡¤ë°±í•˜ëŠ” ì½”ë“œê°€ ëª¨ë‘ ì œê±°ë˜ì—ˆë‹¤.
- íŠ¸ëœì­ì…˜ í…œí”Œë¦¿ì˜ ê¸°ë³¸ ë™ì‘ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.
    - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì •ìƒ ìˆ˜í–‰ë˜ë©´ ì»¤ë°‹í•œë‹¤.
    - ì–¸ì²´íŠ¸ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ë¡¤ë°±í•œë‹¤. ê·¸ ì™¸ì˜ ê²½ìš° ì»¤ë°‹í•œë‹¤. (ì²´í¬ ì˜ˆì™¸ì˜ ê²½ìš°ì—ëŠ” ì»¤ë°‹í•˜ëŠ”ë°, ì´ ë¶€ë¶„ì€ ë’¤ì—ì„œ ì„¤ëª…í•œë‹¤.)
- ì½”ë“œì—ì„œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ `try~catch`ê°€ ë“¤ì–´ê°”ëŠ”ë°, `bizLogic()` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ `SQLException` ì²´í¬ ì˜ˆì™¸ë¥¼ ë„˜ê²¨ì¤€. í•´ë‹¹ ëŒë‹¤ì—ì„œ ì²´í¬ ì˜ˆì™¸ë¥¼ ë°–ìœ¼ë¡œ ë˜ì§ˆ ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ì–¸ì²´í¬ ì˜ˆì™¸ë¡œ ë°”ê¾¸ì–´ ë˜ì§€ë„ë¡ ì˜ˆì™¸ë¥¼ ì „í™˜í–ˆë‹¤.

**MemberServiceV3_2Test**

```java
package hello.jdbc.service;

import hello.jdbc.connection.ConnectionConst;
import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepositoryV3;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.jdbc.datasource.DataSourceTransactionManager;
import org.springframework.jdbc.datasource.DriverManagerDataSource;
import org.springframework.transaction.PlatformTransactionManager;

import java.sql.SQLException;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

/**
 * íŠ¸ëœì­ì…˜ - íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €
 */
class MemberServiceV3_2Test {

    public static final String MEMBER_A = "memberA";
    public static final String MEMBER_B = "memberB";
    public static final String MEMBER_EX = "ex";

    private MemberRepositoryV3 memberRepository;
    private MemberServiceV3_2 memberService;

    @BeforeEach
    void before() {
        DriverManagerDataSource dataSource = new DriverManagerDataSource(ConnectionConst.URL, ConnectionConst.USERNAME, ConnectionConst.PASSWORD);
        **PlatformTransactionManager transactionManager = new DataSourceTransactionManager(dataSource);**

        memberRepository = new MemberRepositoryV3(dataSource);
        **memberService = new MemberServiceV3_2(transactionManager, memberRepository);**
    }

    @AfterEach
    void after() throws SQLException {
        memberRepository.delete(MEMBER_A);
        memberRepository.delete(MEMBER_B);
        memberRepository.delete(MEMBER_EX);
    }

    @Test
    @DisplayName("ì •ìƒ ì´ì²´")
    void accountTransfer() throws SQLException {
        //given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberB = new Member(MEMBER_B, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberB);

        //when
        memberService.accountTransfer(memberA.getMemberId(), memberB.getMemberId(), 2000);

        //then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberB = memberRepository.findById(memberB.getMemberId());
        assertThat(findMemberA.getMoney()).isEqualTo(8000);
        assertThat(findMemberB.getMoney()).isEqualTo(12000);
    }

    @Test
    @DisplayName("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ")
    void accountTransferEx() throws SQLException {
        //given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberEx = new Member(MEMBER_EX, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberEx);

        //when
        assertThatThrownBy(() -> memberService.accountTransfer(memberA.getMemberId(), memberEx.getMemberId(), 2000))
                .isInstanceOf(IllegalStateException.class);

        //then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberEx = memberRepository.findById(memberEx.getMemberId());

        //memberAì˜ ëˆì´ ë¡¤ë°± ë˜ì–´ì•¼í•¨
        assertThat(findMemberA.getMoney()).isEqualTo(10000);
        assertThat(findMemberEx.getMoney()).isEqualTo(10000);
    }

}
```

- í…ŒìŠ¤íŠ¸ ë‚´ìš©ì€ ê¸°ì¡´ê³¼ ê°™ë‹¤.
- í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ë³´ë©´ ì •ìƒ ë™ì‘í•˜ê³ , ì‹¤íŒ¨ì‹œ ë¡¤ë°±ë„ ì˜ ìˆ˜í–‰ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

**ì •ë¦¬**

- íŠ¸ëœì­ì…˜ í…œí”Œë¦¿ ë•ë¶„ì—, íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•  ë•Œ ë°˜ë³µí•˜ëŠ” ì½”ë“œë¥¼ ì œê±°í•  ìˆ˜ ìˆì—ˆë‹¤.
- í•˜ì§€ë§Œ ì´ê³³ì€ ì„œë¹„ìŠ¤ ë¡œì§ì¸ë° ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë¿ë§Œ ì•„ë‹ˆë¼ íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•˜ëŠ” ê¸°ìˆ  ë¡œì§ì´ í•¨ê»˜í¬í•¨ë˜ì–´ ìˆë‹¤.
- ì• í”Œë¦¬ì¼€ì´ì…˜ì„ êµ¬ì„±í•˜ëŠ” ë¡œì§ì„ í•µì‹¬ ê¸°ëŠ¥ê³¼ ë¶€ê°€ ê¸°ëŠ¥ìœ¼ë¡œ êµ¬ë¶„í•˜ìë©´ ì„œë¹„ìŠ¤ ì…ì¥ì—ì„œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ í•µì‹¬ ê¸°ëŠ¥ì´ê³ , íŠ¸ëœì­ì…˜ì€ ë¶€ê°€ ê¸°ëŠ¥ì´ë‹¤.
- ì´ë ‡ê²Œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•˜ëŠ” ê¸°ìˆ  ë¡œì§ì´ í•œ ê³³ì— ìˆìœ¼ë©´ ë‘ ê´€ì‹¬ì‚¬ë¥¼ í•˜ë‚˜ì˜ í´ë˜ìŠ¤ì—ì„œ ì²˜ë¦¬í•˜ê²Œ ëœë‹¤. ê²°ê³¼ì ìœ¼ë¡œ ì½”ë“œë¥¼ ìœ ì§€ë³´ìˆ˜í•˜ê¸° ì–´ë ¤ì›Œì§„ë‹¤.
- ì„œë¹„ìŠ¤ ë¡œì§ì€ ê°€ê¸‰ì  í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ ìˆì–´ì•¼ í•œë‹¤. í•˜ì§€ë§Œ íŠ¸ëœì­ì…˜ ê¸°ìˆ ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì–´ì©” ìˆ˜ ì—†ì´ íŠ¸ëœì­ì…˜ ì½”ë“œê°€ ë‚˜ì™€ì•¼ í•œë‹¤. ì–´ë–»ê²Œ í•˜ë©´ ì´ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆì„ê¹Œ?

## íŠ¸ëœì­ì…˜ ë¬¸ì œ í•´ê²° - íŠ¸ëœì­ì…˜ AOP ì´í•´

- ì§€ê¸ˆê¹Œì§€ íŠ¸ëœì­ì…˜ì„ í¸ë¦¬í•˜ê²Œ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ì„œ íŠ¸ëœì­ì…˜ ì¶”ìƒí™”ë„ ë„ì…í•˜ê³ , ì¶”ê°€ë¡œ ë°˜ë³µì ì¸ íŠ¸ëœì­ì…˜ ë¡œì§ì„ í•´ê²°í•˜ê¸° ìœ„í•´ íŠ¸ëœì­ì…˜ í…œí”Œë¦¿ë„ ë„ì…í–ˆë‹¤.
- íŠ¸ëœì­ì…˜ í…œí”Œë¦¿ ë•ë¶„ì— íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•˜ëŠ” ë°˜ë³µ ì½”ë“œëŠ” í•´ê²°í•  ìˆ˜ ìˆì—ˆë‹¤. í•˜ì§€ë§Œ ì„œë¹„ìŠ¤ ê³„ì¸µì— ìˆœìˆ˜í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ ë‚¨ê¸´ë‹¤ëŠ” ëª©í‘œëŠ” ì•„ì§ ë‹¬ì„±í•˜ì§€ ëª»í–ˆë‹¤.
- ì´ëŸ´ ë•Œ ìŠ¤í”„ë§ AOPë¥¼ í†µí•´ í”„ë¡ì‹œë¥¼ ë„ì…í•˜ë©´ ë¬¸ì œë¥¼ ê¹”ë”í•˜ê²Œ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

> ğŸ’¡Â ì°¸ê³ 
ìŠ¤í”„ë§ AOPì™€ í”„ë¡ì‹œì— ëŒ€í•´ì„œ ì§€ê¸ˆì€ ìì„¸íˆ ì´í•´í•˜ì§€ ëª»í•´ë„ ê´œì°®ë‹¤. ì§€ê¸ˆì€ @Transactionalì„ ìƒìš”í•˜ë©´ ìŠ¤í”„ë§ AOPë¥¼ ì‚¬ìš©í•´ì„œ íŠ¸ëœì­ì…˜ì„ í¸ë¦¬í•˜ê²Œ ì²˜ë¦¬í•´ì¤€ë‹¤ ì •ë„ë¡œ ì´í•´í•´ë„ ëœë‹¤. ìŠ¤í”„ë§ AOPì™€ í”„ë¡ì‹œì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ **ìŠ¤í”„ë§ í•µì‹¬ ì›ë¦¬ - ê³ ê¸‰í¸**ì„ ì°¸ê³ í•˜ì.
> 

### í”„ë¡ì‹œë¥¼ í†µí•œ ë¬¸ì œ í•´ê²°

**í”„ë¡ì‹œ ë„ì… ì „**

![Untitled 10](https://github.com/soohyunnn/spring_db_1/assets/58289675/1742d0cb-a34d-41db-9ec3-d608c1751273)

í”„ë¡ì‹œë¥¼ ë„ì…í•˜ê¸° ì „ì—ëŠ” ê¸°ì¡´ì²˜ëŸ¼ ì„œë¹„ìŠ¤ì˜ ë¡œì§ì—ì„œ íŠ¸ëœì­ì…˜ì„ ì§ì ‘ ì‹œì‘í•œë‹¤.

**ì„œë¹„ìŠ¤ ê³„ì¸µì˜ íŠ¸ëœì­ì…˜ ì‚¬ìš© ì½”ë“œ ì˜ˆì‹œ**

```java
//íŠ¸ëœì­ì…˜ ì‹œì‘
TransactionStatus status = transactionManager.getTransaction(new DefaultTransactionDefinition());

try {
    //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
    bizLogic(fromId, toId, money);
    transactionManager.commit(status);  //ì„±ê³µì‹œ ì»¤ë°‹
} catch (Exception e) {
    transactionManager.rollback(status);  //ì‹¤íŒ¨ì‹œ ë¡¤ë°±
    throw new IllegalStateException(e);
}
```

**í”„ë¡ì‹œ ë„ì… í›„**

![Untitled 11](https://github.com/soohyunnn/spring_db_1/assets/58289675/2da99171-02b8-4dde-9aa5-ba000c69ec7d)

í”„ë¡ì‹œë¥¼ ì‚¬ìš©í•˜ë©´ íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•˜ëŠ” ê°ì²´ì™€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” ì„œë¹„ìŠ¤ ê°ì²´ë¥¼ ëª…í™•í•˜ê²Œ ë¶„ë¦¬í•  ìˆ˜ ìˆë‹¤.

**íŠ¸ëœì­ì…˜ í”„ë¡ì‹œ ì½”ë“œ ì˜ˆì‹œ**

```java
public class TransactionProxy {

  private MemberService target;

  public void logic() { 
			//íŠ¸ëœì­ì…˜ ì‹œì‘
      TransactionStatus status = transactionManager.getTransaction(..);
      try {
				  //ì‹¤ì œ ëŒ€ìƒ í˜¸ì¶œ 
					target.logic();
          transactionManager.commit(status); //ì„±ê³µì‹œ ì»¤ë°‹ 
			} catch (Exception e) {
          transactionManager.rollback(status); //ì‹¤íŒ¨ì‹œ ë¡¤ë°±
          throw new IllegalStateException(e);
      }
  }

}
```

**íŠ¸ëœì­ì…˜ í”„ë¡ì‹œ ì ìš© í›„ ì„œë¹„ìŠ¤ ì½”ë“œ ì˜ˆì‹œ**

```java
public class Service {

      public void logic() {
					//íŠ¸ëœì­ì…˜ ê´€ë ¨ ì½”ë“œ ì œê±°, ìˆœìˆ˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ ë‚¨ìŒ
          bizLogic(fromId, toId, money);
      }

}
```

- í”„ë¡ì‹œ ë„ì… ì „ : ì„œë¹„ìŠ¤ì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ë¡œì§ì´ í•¨ê»˜ ì„ì—¬ìˆë‹¤.
- í”„ë¡ì‹œ ë„ì… í›„ : íŠ¸ëœì­ì…˜ í”„ë¡ì‹œê°€ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ë¡œì§ì„ ëª¨ë‘ ê°€ì ¸ê°„ë‹¤. ê·¸ë¦¬ê³  íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•œ í›„ì— ì‹¤ì œ ì„œë¹„ìŠ¤ë¥¼ ëŒ€ì‹  í˜¸ì¶œí•œë‹¤. íŠ¸ëœì­ì…˜ í”„ë¡ì‹œ ë•ë¶„ì— ì„œë¹„ìŠ¤ ê³„ì¸µì—ëŠ” ìˆœìˆ˜í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ ë‚¨ê¸¸ ìˆ˜ ìˆë‹¤.

### ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” íŠ¸ëœì­ì…˜ AOP

- ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” AOP ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ í”„ë¡ì‹œë¥¼ ë§¤ìš° í¸ë¦¬í•˜ê²Œ ì ìš©í•  ìˆ˜ ìˆë‹¤. (`@Aspect`, `@Advice`, `@Pointcut`)
- ë¬¼ë¡  ìŠ¤í”„ë§ AOPë¥¼ ì§ì ‘ ì‚¬ìš©í•´ì„œ íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•´ë„ ë˜ì§€ë§Œ, íŠ¸ëœì­ì…˜ì€ ë§¤ìš° ì¤‘ìš”í•œ ê¸°ëŠ¥ì´ê³ , ì „ì„¸ê³„ ëˆ„êµ¬ë‚˜ ë‹¤ ì‚¬ìš©í•˜ëŠ” ê¸°ëŠ¥ì´ë‹¤. ìŠ¤í”„ë§ì€ íŠ¸ëœì­ì…˜ AOPë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ëª¨ë“  ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤. ìŠ¤í”„ë§ ë¶€íŠ¸ë¥¼ ì‚¬ìš©í•˜ë©´ íŠ¸ëœì­ì…˜ AOPë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ìŠ¤í”„ë§ ë¹ˆë“¤ë„ ìë™ìœ¼ë¡œ ë“±ë¡í•´ì¤€ë‹¤.
- ê°œë°œìëŠ” íŠ¸ëœì­ì…˜ ì²˜ë¦¬ê°€ í•„ìš”í•œ ê³³ì— `@Transactional` ì–´ë…¸í…Œì´ì…˜ë§Œ ë¶™ì—¬ì£¼ë©´ ëœë‹¤. ìŠ¤í”„ë§ì˜ íŠ¸ëœì­ì…˜ AOPëŠ” ì´ ì–´ë…¸í…Œì´ì…˜ì„ ì¸ì‹í•´ì„œ íŠ¸ëœì­ì…˜ í”„ë¡ì‹œë¥¼ ì ìš©í•´ì¤€ë‹¤.

**@Transactional**

`org.springframework.transaction.annotation.Transactional`

> ğŸ’¡Â ì°¸ê³ 
ìŠ¤í”„ë§ AOPë¥¼ ì ìš©í•˜ë ¤ë©´ ì–´ë“œë°”ì´ì €, í¬ì¸íŠ¸ì»·, ì–´ë“œë°”ì´ìŠ¤ê°€ í•„ìš”í•˜ë‹¤. ìŠ¤í”„ë§ì€ íŠ¸ëœì­ì…˜ AOP ì²˜ë¦¬ë¥¼ ìœ„í•´ ë‹¤ìŒ í´ë˜ìŠ¤ë¥¼ ì œê³µí•œë‹¤. ìŠ¤í”„ë§ ë¶€íŠ¸ë¥¼ ì‚¬ìš©í•˜ë©´ í•´ë‹¹ ë¹ˆë“¤ì€ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ìë™ìœ¼ë¡œ ë“±ë¡ëœë‹¤.

ì–´ë“œë°”ì´ì € : `BeanFactoryTransactionAttributeSourceAdvisor`
í¬ì¸íŠ¸ì»· : `TransactionAttributeSourcePointcut`
ì–´ë“œë°”ì´ìŠ¤ : `TransactionInterceptor`
> 

## íŠ¸ëœì­ì…˜ ë¬¸ì œ í•´ê²° - íŠ¸ëœì­ì…˜ AOP ì ìš©

íŠ¸ëœì­ì…˜ AOPë¥¼ ì‚¬ìš©í•˜ëŠ” ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì.

**MemberServiceV3_3**

```java
package hello.jdbc.service;

import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepositoryV3;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.support.TransactionTemplate;

import java.sql.SQLException;

/**
 * íŠ¸ëœì­ì…˜ - @Transactional AOP
 */
@Slf4j
@RequiredArgsConstructor
public class MemberServiceV3_3 {

    private final MemberRepositoryV3 memberRepository;

    @Transactional
    public void accountTransfer(String fromId, String toId, int money) throws SQLException {

        bizLogic(fromId, toId, money);

    }

    private void bizLogic(String fromId, String toId, int money) throws  SQLException {
        Member fromMember = memberRepository.findById(fromId);
        Member toMember = memberRepository.findById(toId);

        memberRepository.update(fromId, fromMember.getMoney() - money);
        validation(toMember);
        memberRepository.update(toId, toMember.getMoney() + money);

    }

    private void validation(Member toMember) {
        if (toMember.getMemberId().equals("ex")) {
            throw new IllegalStateException("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ");
        }
    }

}
```

- ìˆœìˆ˜í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ ë‚¨ê¸°ê³ , íŠ¸ëœì­ì…˜ ê´€ë ¨ ì½”ë“œëŠ” ëª¨ë‘ ì œê±°í–ˆë‹¤.
- ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” íŠ¸ëœì­ì…˜ AOPë¥¼ ì ìš©í•˜ê¸° ìœ„í•´ `@Transactional` ì–´ë…¸í…Œì´ì…˜ì„ ì¶”ê°€í–ˆë‹¤.
- `@Transactional` ì–´ë…¸í…Œì´ì…˜ì€ ë©”ì„œë“œì— ë¶™ì—¬ë„ ë˜ê³ , í´ë˜ìŠ¤ì— ë¶™ì—¬ë„ ëœë‹¤. í´ë˜ìŠ¤ì— ë¶™ì´ë©´ ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•œ `public` ë©”ì„œë“œê°€ AOP ì ìš© ëŒ€ìƒì´ ëœë‹¤.

**MemberServiceV3_3Test**

```java
package hello.jdbc.service;

import hello.jdbc.connection.ConnectionConst;
import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepositoryV3;
import lombok.extern.slf4j.Slf4j;

import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.aop.support.AopUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.jdbc.datasource.DataSourceTransactionManager;
import org.springframework.jdbc.datasource.DriverManagerDataSource;
import org.springframework.transaction.PlatformTransactionManager;

import javax.sql.DataSource;
import java.sql.SQLException;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

/**
 * íŠ¸ëœì­ì…˜ - @Transactional AOP
 */
@Slf4j
@SpringBootTest
class MemberServiceV3_3Test {

    public static final String MEMBER_A = "memberA";
    public static final String MEMBER_B = "memberB";
    public static final String MEMBER_EX = "ex";

    @Autowired
    MemberRepositoryV3 memberRepository;

    @Autowired
    MemberServiceV3_2 memberService;

    @AfterEach
    void after() throws SQLException {
        memberRepository.delete(MEMBER_A);
        memberRepository.delete(MEMBER_B);
        memberRepository.delete(MEMBER_EX);
    }

    **@TestConfiguration
    static class TestConfig {

        @Bean
        DataSource dataSource() {
            return new DriverManagerDataSource(ConnectionConst.URL, ConnectionConst.USERNAME, ConnectionConst.PASSWORD);
        }

        @Bean
        PlatformTransactionManager transactionManager() {
            return new DataSourceTransactionManager(dataSource());
        }

        @Bean
        MemberRepositoryV3 memberRepositoryV3() {
            return new MemberRepositoryV3(dataSource());
        }

        @Bean
        MemberServiceV3_3 memberServiceV3_3() {
            return new MemberServiceV3_3(memberRepositoryV3());
        }

    }**

    @Test
    void AopCheck() {
        log.info("memberService class={}", memberService.getClass());
        log.info("memberRepository class={}", memberRepository.getClass());
        assertThat(AopUtils.isAopProxy(memberService)).isTrue();
        assertThat(AopUtils.isAopProxy(memberRepository)).isFalse();
    }
    

    @Test
    @DisplayName("ì •ìƒ ì´ì²´")
    void accountTransfer() throws SQLException {
        //given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberB = new Member(MEMBER_B, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberB);

        //when
        memberService.accountTransfer(memberA.getMemberId(), memberB.getMemberId(), 2000);

        //then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberB = memberRepository.findById(memberB.getMemberId());
        assertThat(findMemberA.getMoney()).isEqualTo(8000);
        assertThat(findMemberB.getMoney()).isEqualTo(12000);
    }

    @Test
    @DisplayName("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ")
    void accountTransferEx() throws SQLException {
        //given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberEx = new Member(MEMBER_EX, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberEx);

        //when
        assertThatThrownBy(() -> memberService.accountTransfer(memberA.getMemberId(), memberEx.getMemberId(), 2000))
                .isInstanceOf(IllegalStateException.class);

        //then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberEx = memberRepository.findById(memberEx.getMemberId());

        //memberAì˜ ëˆì´ ë¡¤ë°± ë˜ì–´ì•¼í•¨
        assertThat(findMemberA.getMoney()).isEqualTo(10000);
        assertThat(findMemberEx.getMoney()).isEqualTo(10000);
    }

}
```

- `@SpringBootTest` : ìŠ¤í”„ë§ AOPë¥¼ ì ìš©í•˜ë ¤ë©´ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆê°€ í•„ìš”í•˜ë‹¤. ì´ ì–´ë…¸í…Œì´ì…˜ì´ ìˆìœ¼ë©´ í…ŒìŠ¤íŠ¸ì‹œ ìŠ¤í”„ë§ ë¶€íŠ¸ë¥¼ í†µí•´ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•œë‹¤. ê·¸ë¦¬ê³  í…ŒìŠ¤íŠ¸ì—ì„œ `@Autowired` ë“±ì„ í†µí•´ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆê°€ ê´€ë¦¬í•˜ëŠ” ë¹ˆë“¤ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
- `@TestConfiguration` : í…ŒìŠ¤íŠ¸ ì•ˆì—ì„œ ë‚´ë¶€ ì„¤ì • í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ì„œ ì‚¬ìš©í•˜ë©´ì„œ ì´ ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì´ë©´, ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ëŠ” ë¹ˆë“¤ì— ì¶”ê°€ë¡œ í•„ìš”í•œ ìŠ¤í”„ë§ ë¹ˆë“¤ì„ ë“±ë¡í•˜ê³  í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.
- `TestConfig`
    - `DataSource` ìŠ¤í”„ë§ì—ì„œ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©í•  ë°ì´í„°ì†ŒìŠ¤ë¥¼ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•œë‹¤. ì¶”ê°€ë¡œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ì—ì„œë„ ì‚¬ìš©í•œë‹¤.
    - `DataSourceTransactionManager` íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•œë‹¤.
        - ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” íŠ¸ëœì­ì…˜ AOPëŠ” ìŠ¤í”„ë§ ë¹ˆì— ë“±ë¡ëœ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì°¾ì•„ì„œ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•´ë‘ì–´ì•¼ í•œë‹¤.

**AOP í”„ë¡ì‹œ ì ìš© í™•ì¸**

```java
@Test
void AopCheck() {
    log.info("memberService class={}", memberService.getClass());
    log.info("memberRepository class={}", memberRepository.getClass());
    assertThat(AopUtils.isAopProxy(memberService)).isTrue();
    assertThat(AopUtils.isAopProxy(memberRepository)).isFalse();
}
```

**ì‹¤í–‰ ê²°ê³¼ - AopCheck()**

```java
memberService class=class hello.jdbc.service.MemberServiceV3_3$
$EnhancerBySpringCGLIB$$...
memberRepository class=class hello.jdbc.repository.MemberRepositoryV3
```

- ë¨¼ì € AOP í”„ë¡ì‹œê°€ ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ë³´ì. `AopCheck()`ì˜ ì‹¤í–‰ ê²°ê³¼ë¥¼ ë³´ë©´ `memberService`ì— `EnhancerBySpringCGLIBâ€¦` ë¼ëŠ” ë¶€ë¶„ì„ í†µí•´ í”„ë¡ì‹œ(CGLIB)ê°€ ì ìš©ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
    
    `memberRepository`ì—ëŠ” AOPë¥¼ ì ìš©í•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— í”„ë¡ì‹œê°€ ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤.
    
- ë‚˜ë¨¸ì§€ í…ŒìŠ¤íŠ¸ ì½”ë“œë“¤ì„ ì‹¤í–‰í•´ë³´ë©´ íŠ¸ëœì­ì…˜ì´ ì •ìƒ ìˆ˜í–‰ë˜ê³ , ì‹¤íŒ¨ì‹œ ì •ìƒ ë¡¤ë°±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

## íŠ¸ëœì­ì…˜ ë¬¸ì œ í•´ê²° - íŠ¸ëœì­ì…˜ AOP ì •ë¦¬

íŠ¸ëœì­ì…˜ AOPê°€ ì‚¬ìš©ëœ ì „ì²´ íë¦„ì„ ê·¸ë¦¼ìœ¼ë¡œ ì •ë¦¬í•´ë³´ì.

**íŠ¸ëœì­ì…˜ AOP ì ìš© ì „ì²´ íë¦„**

![Untitled 12](https://github.com/soohyunnn/spring_db_1/assets/58289675/be963b80-dcb5-48f0-9b8c-59d666626091)

**ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ê´€ë¦¬ vs í”„ë¡œê·¸ë˜ë° ë°©ì‹ íŠ¸ëœì­ì…˜ ê´€ë¦¬**

- ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ê´€ë¦¬(Declarative Transaction Management)
    - `@Transactional` ì–´ë…¸í…Œì´ì…˜ í•˜ë‚˜ë§Œ ì„ ì–¸í•´ì„œ ë§¤ìš° í¸ë¦¬í•˜ê²Œ íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ëŠ” ê²ƒì„ ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ê´€ë¦¬ë¼ í•œë‹¤.
    - ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ê´€ë¦¬ëŠ” ê³¼ê±° XMLì— ì„¤ì •í•˜ê¸°ë„ í–ˆë‹¤. ì´ë¦„ ê·¸ëŒ€ë¡œ í•´ë‹¹ ë¡œì§ì— íŠ¸ëœì­ì…˜ì— ì ìš©í•˜ê² ë‹¤ ë¼ê³  ì–´ë”˜ê°€ì— ì„ ì–¸í•˜ê¸°ë§Œ í•˜ë©´ íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ëŠ” ë°©ì‹ì´ë‹¤.
- í”„ë¡œê·¸ë˜ë° ë°©ì‹ì˜ íŠ¸ëœì­ì…˜ ê´€ë¦¬(programmatic transaction management)
    - íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € ë˜ëŠ” íŠ¸ëœì­ì…˜ í…œí”Œë¦¿ ë“±ì„ ì‚¬ìš©í•´ì„œ íŠ¸ëœì­ì…˜ ê´€ë ¨ ì½”ë“œë¥¼ ì§ì ‘ ì‘ì„±í•˜ëŠ” ê²ƒì„ í”„ë¡œê·¸ë˜ë° ë°©ì‹ì˜ íŠ¸ëœì­ì…˜ ê´€ë¦¬ë¼ í•œë‹¤.

- ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ê´€ë¦¬ê°€ í”„ë¡œê·¸ë˜ë° ë°©ì‹ì— ë¹„í•´ì„œ í›¨ì”¬ ê°„í¸í•˜ê³  ì‹¤ìš©ì ì´ê³  ë•Œë¬¸ì— ì‹¤ë¬´ì—ì„œëŠ” ëŒ€ë¶€ë¶„ ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ê´€ë¦¬ë¥¼ ì‚¬ìš©í•œë‹¤.
- í”„ë¡œê·¸ë˜ë° ë°©ì‹ì˜ íŠ¸ëœì­ì…˜ ê´€ë¦¬ëŠ” ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆë‚˜ ìŠ¤í”„ë§ AOP ê¸°ìˆ  ì—†ì´ ê°„ë‹¨íˆ ì‚¬ìš©í•  ìˆ˜ ìˆì§€ë§Œ ì‹¤ë¬´ì—ì„œëŠ” ëŒ€ë¶€ë¶„ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì™€ ìŠ¤í”„ë§ AOPë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ê±°ì˜ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤.
- í”„ë¡œê·¸ë˜ë° ë°©ì‹ íŠ¸ëœì­ì…˜ ê´€ë¦¬ëŠ” í…ŒìŠ¤íŠ¸ ì‹œì— ê°€ë” ì‚¬ìš©ë  ë•ŒëŠ” ìˆë‹¤.

**ì •ë¦¬**

- ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ê´€ë¦¬ ë•ë¶„ì— ë“œë””ì–´ íŠ¸ëœì­ì…˜ ê´€ë ¨ ì½”ë“œë¥¼ ìˆœìˆ˜í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œ ì œê±°í•  ìˆ˜ ìˆì—ˆë‹¤.
- ê°œë°œìëŠ” íŠ¸ëœì­ì…˜ì´ í•„ìš”í•œ ê³³ì— `@Transactional` ì–´ë…¸í…Œì´ì…˜ í•˜ë‚˜ë§Œ ì¶”ê°€í•˜ë©´ ëœë‹¤. ë‚˜ë¨¸ì§€ëŠ” ìŠ¤í”„ë§ íŠ¸ëœì­ì…˜ AOPê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì¤€ë‹¤.
- `@Transactional` ì–´ë…¸í…Œì´ì…˜ì˜ ìì„¸í•œ ì‚¬ìš©ë²•ì€ ë’¤ì—ì„œ ì„¤ëª…í•œë‹¤. ì§€ê¸ˆì€ ì „ì²´ êµ¬ì¡°ë¥¼ ì´í•´í•˜ëŠ”ë° ì´ˆì ì„ ë§ì¶”ì.

## ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ ìë™ ë¦¬ì†ŒìŠ¤ ë“±ë¡

ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ë“±ì¥í•˜ê¸° ì´ì „ì—ëŠ” ë°ì´í„°ì†ŒìŠ¤ì™€ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ê°œë°œìê°€ ì§ì ‘ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•´ì„œ ì‚¬ìš©í–ˆë‹¤. 

ì´ ë¶€ë¶„ì„ ì ì‹œ ì‚´í´ë³´ì.

**ë°ì´í„°ì†ŒìŠ¤ì™€ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ì§ì ‘ ë“±ë¡**

```java
@Bean
DataSource dataSource() {
	return new DriverManagerDataSource(URL, USERNAME, PASSWORD);
}

@Bean
PlatformTransactionManager transactionManager() {
    return new DataSourceTransactionManager(dataSource());
}
```

ê¸°ì¡´ì—ëŠ” ì´ë ‡ê²Œ ë°ì´í„°ì†ŒìŠ¤ì™€ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì§ì ‘ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•´ì•¼ í–ˆë‹¤. ê·¸ëŸ°ë° ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ë‚˜ì˜¤ë©´ì„œ ë§ì€ ë¶€ë¶„ì´ ìë™í™”ë˜ì—ˆë‹¤. (ë” ì˜¤ë˜ì „ì— ìŠ¤í”„ë§ì„ ë‹¤ë£¨ì–´ì™”ë‹¤ë©´ í•´ë‹¹ ë¶€ë¶„ì„ ì£¼ë¡œ XMLë¡œ ë“±ë¡í•˜ê³  ê´€ë¦¬í–ˆì„ ê²ƒì´ë‹¤.)

**ë°ì´í„°ì†ŒìŠ¤ - ìë™ ë“±ë¡**

- ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” ë°ì´í„°ì†ŒìŠ¤(`DataSource`)ë¥¼ ìŠ¤í”„ë§ ë¹ˆì— ìë™ìœ¼ë¡œ ë“±ë¡í•œë‹¤.
- ìë™ìœ¼ë¡œ ë“±ë¡ë˜ëŠ” ìŠ¤í”„ë§ ë¹ˆ ì´ë¦„: `dataSource`
- ì°¸ê³ ë¡œ ê°œë°œìê°€ ì§ì ‘ ë°ì´í„°ì†ŒìŠ¤ë¥¼ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ë©´ ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” ë°ì´í„°ì†ŒìŠ¤ë¥¼ ìë™ìœ¼ë¡œ ë“±ë¡í•˜ì§€ ì•ŠëŠ”ë‹¤.

ì´ë•Œ ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ì´ `application.properties`ì— ìˆëŠ” ì†ì„±ì„ ì‚¬ìš©í•´ì„œ `DataSource`ë¥¼ ìƒì„±í•œë‹¤. ê·¸ë¦¬ê³  ìŠ¤í”„ë§ ë¹ˆì— ë“±ë¡í•œë‹¤.

`application.properties`

```java
spring.datasource.url=jdbc:h2:tcp://localhost/~/test
spring.datasource.username=sa
spring.datasource.password=
```

- ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ê¸°ë³¸ìœ¼ë¡œ ìƒì„±í•˜ëŠ” ë°ì´í„°ì†ŒìŠ¤ëŠ” ì»¤ë„¥ì…˜í’€ì„ ì œê³µí•˜ëŠ” `HikariDataSource`ì´ë‹¤.
    
    ì»¤ë„¥ì…˜í’€ê³¼ ê´€ë ¨ëœ ì„¤ì •ë„ `application.properties`ë¥¼ í†µí•´ì„œ ì§€ì •í•  ìˆ˜ ìˆë‹¤.
    
- `spring.datasource.url` ì†ì„±ì´ ì—†ìœ¼ë©´ ë‚´ì¥ ë°ì´í„°ë² ì´ìŠ¤(ë©”ëª¨ë¦¬ DB)ë¥¼ ìƒì„±í•˜ë ¤ê³  ì‹œë„í•œë‹¤.

**íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € - ìë™ ë“±ë¡**

- ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” ì ì ˆí•œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €(`PlatformTransactionManager`)ë¥¼ ìë™ìœ¼ë¡œ ìŠ¤í”„ë§ ë¹ˆì— ë“±ë¡í•œë‹¤.
- ìë™ìœ¼ë¡œ ë“±ë¡ë˜ëŠ” ìŠ¤í”„ë§ ë¹ˆ ì´ë¦„ : `transactionManager`
- ì°¸ê³ ë¡œ ê°œë°œìê°€ ì§ì ‘ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ë©´ ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ìë™ìœ¼ë¡œ ë“±ë¡í•˜ì§€ ì•ŠëŠ”ë‹¤.

ì–´ë–¤ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì„ íƒí• ì§€ëŠ” í˜„ì¬ ë“±ë¡ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë³´ê³  íŒë‹¨í•˜ëŠ”ë°, JDBCë¥¼ ê¸°ìˆ ì„ ì‚¬ìš©í•˜ë©´ `DataSourceTransactionManager`ë¥¼ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ê³ , JPAë¥¼ ì‚¬ìš©í•˜ë©´ JpaTransactionManagerë¥¼ ë¹ˆìœ¼ë¡œ ë“±ë¡í•œë‹¤. ë‘˜ë‹¤ ì‚¬ìš©í•˜ëŠ” ê²½ìš° `JpaTransactionManager`ë¥¼ ë“±ë¡í•œë‹¤. ì°¸ê³ ë¡œ `JpaTransactionManager`ëŠ” `DataSourceTransactionManager`ê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ë„ ëŒ€ë¶€ë¶„ ì§€ì›í•œë‹¤.

**ë°ì´í„°ì†ŒìŠ¤, íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € ì§ì ‘ ë“±ë¡**

```java
@TestConfiguration
static class TestConfig {

    @Bean
    DataSource dataSource() {
        return new DriverManagerDataSource(ConnectionConst.URL, ConnectionConst.USERNAME, ConnectionConst.PASSWORD);
    }

    @Bean
    PlatformTransactionManager transactionManager() {
        return new DataSourceTransactionManager(dataSource());
    }

    @Bean
    MemberRepositoryV3 memberRepositoryV3() {
        return new MemberRepositoryV3(dataSource());
    }

    @Bean
    MemberServiceV3_3 memberServiceV3_3() {
        return new MemberServiceV3_3(memberRepositoryV3());
    }

}
```

- ì´ì „ì— ì‘ì„±í•œ ì½”ë“œì´ë‹¤. ì´ë ‡ê²Œ ë°ì´í„°ì†ŒìŠ¤ì™€ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì§ì ‘ ë“±ë¡í•˜ë©´ ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” ë°ì´í„°ì†ŒìŠ¤ì™€ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ìë™ìœ¼ë¡œ ë“±ë¡í•˜ì§€ ì•ŠëŠ”ë‹¤.

ì´ë²ˆì—ëŠ” ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ì œê³µí•˜ëŠ” ìë™ ë“±ë¡ì„ ì´ìš©í•´ì„œ ë°ì´í„°ì†ŒìŠ¤ì™€ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ í¸ë¦¬í•˜ê²Œ ì ìš©í•´ë³´ì.

ë¨¼ì € `application.properties`ì— ë‹¤ìŒì„ ì¶”ê°€í•˜ì.

**ë°ì´í„°ì†ŒìŠ¤ì™€ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € ìë™ ë“±ë¡**

**application.properties**

```java
spring.datasource.url=jdbc:h2:tcp://localhost/~/test
spring.datasource.username=sa
spring.datasource.password=
```

**MemberServiceV3_4Test**

```java
package hello.jdbc.service;

import hello.jdbc.connection.ConnectionConst;
import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepositoryV3;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.aop.support.AopUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.jdbc.datasource.DataSourceTransactionManager;
import org.springframework.jdbc.datasource.DriverManagerDataSource;
import org.springframework.transaction.PlatformTransactionManager;

import javax.sql.DataSource;
import java.sql.SQLException;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

/**
 * íŠ¸ëœì­ì…˜ - DataSource, transactionManager ìë™ ë“±ë¡
 */
@Slf4j
@SpringBootTest
class MemberServiceV3_4Test {

    public static final String MEMBER_A = "memberA";
    public static final String MEMBER_B = "memberB";
    public static final String MEMBER_EX = "ex";

    @Autowired
    MemberRepositoryV3 memberRepository;

    @Autowired
    MemberServiceV3_3 memberService;

    @AfterEach
    void after() throws SQLException {
        memberRepository.delete(MEMBER_A);
        memberRepository.delete(MEMBER_B);
        memberRepository.delete(MEMBER_EX);
    }

    **@TestConfiguration
    static class TestConfig {

        private final DataSource dataSource;

        public TestConfig(DataSource dataSource) {
            this.dataSource = dataSource;
        }

        @Bean
        MemberRepositoryV3 memberRepositoryV3() {
            return new MemberRepositoryV3(dataSource);
        }

        @Bean
        MemberServiceV3_3 memberServiceV3_3() {
            return new MemberServiceV3_3(memberRepositoryV3());
        }

    }**

    @Test
    void AopCheck() {
        log.info("memberService class={}", memberService.getClass());
        log.info("memberRepository class={}", memberRepository.getClass());
        assertThat(AopUtils.isAopProxy(memberService)).isTrue();
        assertThat(AopUtils.isAopProxy(memberRepository)).isFalse();
    }

    @Test
    @DisplayName("ì •ìƒ ì´ì²´")
    void accountTransfer() throws SQLException {
        //given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberB = new Member(MEMBER_B, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberB);

        //when
        memberService.accountTransfer(memberA.getMemberId(), memberB.getMemberId(), 2000);

        //then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberB = memberRepository.findById(memberB.getMemberId());
        assertThat(findMemberA.getMoney()).isEqualTo(8000);
        assertThat(findMemberB.getMoney()).isEqualTo(12000);
    }

    @Test
    @DisplayName("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ")
    void accountTransferEx() throws SQLException {
        //given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberEx = new Member(MEMBER_EX, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberEx);

        //when
        assertThatThrownBy(() -> memberService.accountTransfer(memberA.getMemberId(), memberEx.getMemberId(), 2000))
                .isInstanceOf(IllegalStateException.class);

        //then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberEx = memberRepository.findById(memberEx.getMemberId());

        //memberAì˜ ëˆì´ ë¡¤ë°± ë˜ì–´ì•¼í•¨
        assertThat(findMemberA.getMoney()).isEqualTo(10000);
        assertThat(findMemberEx.getMoney()).isEqualTo(10000);
    }

}
```

- ê¸°ì¡´(`MemberServiceV3_3Test`)ê³¼ ê°™ì€ ì½”ë“œì´ê³  `TestConfig` ë¶€ë¶„ë§Œ ë‹¤ë¥´ë‹¤.
- ë°ì´í„°ì†ŒìŠ¤ì™€ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ëŠ” ì½”ë“œê°€ ìƒëµë˜ì—ˆë‹¤. ë”°ë¼ì„œ ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ `application.properties`ì— ì§€ì •ëœ ì†ì„±ì„ ì°¸ê³ í•´ì„œ ë°ì´í„°ì†ŒìŠ¤ì™€ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•´ì¤€ë‹¤.
- ì½”ë“œì—ì„œ ë³´ëŠ” ê²ƒ ì²˜ëŸ¼ ìƒì„±ìë¥¼ í†µí•´ì„œ ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ë§Œë“¤ì–´ì¤€ ë°ì´í„°ì†ŒìŠ¤ ë¹ˆì„ ì£¼ì… ë°›ì„ ìˆ˜ë„ ìˆë‹¤.

ì‹¤í–‰í•´ë³´ë©´ ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì •ìƒ ìˆ˜í–‰ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

**ì •ë¦¬**

- ë°ì´í„°ì†ŒìŠ¤ì™€ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ëŠ” ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ì œê³µí•˜ëŠ” ìë™ ë¹ˆ ë“±ë¡ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ í¸ë¦¬í•˜ë‹¤.
- ì¶”ê°€ë¡œ `application.properties`ë¥¼ í†µí•´ ì„¤ì •ë„ í¸ë¦¬í•˜ê²Œ í•  ìˆ˜ ìˆë‹¤.

> ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ ë°ì´í„°ì†ŒìŠ¤ ìë™ ë“±ë¡ì— ëŒ€í•œ ë” ìì„¸í•œ ë‚´ìš©ì€ ë‹¤ìŒ ìŠ¤í”„ë§ ë¶€íŠ¸ ê³µì‹ ë©”ë‰´ì–¼ì„ ì°¸ê³ í•˜ì.
> 

[Data](https://docs.spring.io/spring-boot/docs/current/reference/html/data.html#data.sql.datasource.production)

> ìì„¸í•œ ì„¤ì • ì†ì„±ì€ ë‹¤ìŒì„ ì°¸ê³ í•˜ì.
> 

[Common Application Properties](https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html)